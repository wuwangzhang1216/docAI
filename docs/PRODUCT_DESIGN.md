# Heart Guardian AI äº§å“è®¾è®¡æŠ¥å‘Š

> ç‰ˆæœ¬ï¼š1.0.0 | æœ€åæ›´æ–°ï¼š2026-02-09

## ğŸ“‹ äº§å“æ¦‚è¿°

### äº§å“å®šä½

Heart Guardian AIï¼ˆå¿ƒå®ˆAI / XinShouCaiï¼‰æ˜¯ä¸€ä¸ªåŸºäºAIæŠ€æœ¯çš„ç²¾ç¥å¥åº·æ”¯æŒå¹³å°ï¼Œä¸“é—¨ä¸º**æ”¿æ²»åˆ›ä¼¤å¹¸å­˜è€…**ï¼ˆéš¾æ°‘ã€å¼‚è®®äººå£«ç­‰ï¼‰è®¾è®¡ï¼Œæä¾›24/7æƒ…æ„Ÿæ”¯æŒã€å¥åº·è¿½è¸ªã€å¿ƒç†è¯„ä¼°å’ŒåŒ»æ‚£åä½œåŠŸèƒ½ã€‚

### æ ¸å¿ƒä»·å€¼ä¸»å¼ 

- ğŸ¤– **AIæƒ…æ„Ÿé™ªä¼´**ï¼šåŸºäºAnthropic Claudeçš„æµå¼AIå¯¹è¯ï¼Œæä¾›å³æ—¶çš„æƒ…æ„Ÿæ”¯æŒ
- ğŸ›¡ï¸ **é£é™©é¢„è­¦ç³»ç»Ÿ**ï¼šå¤šè¯­è¨€è‡ªåŠ¨é£é™©æ£€æµ‹ï¼Œæ”¯æŒä¸­æ–‡ã€è‹±è¯­ã€æ³¢æ–¯è¯­ã€åœŸè€³å…¶è¯­ã€è¥¿ç­ç‰™è¯­
- ğŸ¥ **åŒ»æ‚£ååŒ**ï¼šå®æ—¶é€šä¿¡ç³»ç»Ÿï¼Œè¿æ¥æ‚£è€…ä¸ä¸“ä¸šåŒ»ç”Ÿ
- ğŸ“Š **æ•°æ®é©±åŠ¨**ï¼šç§‘å­¦çš„å¿ƒç†è¯„ä¼°é‡è¡¨å’Œå¥åº·æ•°æ®è¿½è¸ª

### äº§å“æ„¿æ™¯

ä¸ºæ”¿æ²»åˆ›ä¼¤å¹¸å­˜è€…æä¾›å®‰å…¨ã€ä¸“ä¸šã€å¯åŠçš„å¿ƒç†å¥åº·æ”¯æŒï¼Œé€šè¿‡AIæŠ€æœ¯é™ä½å¿ƒç†å¥åº·æœåŠ¡çš„é—¨æ§›ï¼ŒåŒæ—¶èµ‹èƒ½åŒ»ç–—ä¸“ä¸šäººå‘˜æä¾›æ›´é«˜æ•ˆçš„æŠ¤ç†ã€‚

---

## ğŸ‘¥ ç”¨æˆ·è§’è‰²

### 1. æ‚£è€…ï¼ˆPatientï¼‰

**ç›®æ ‡ç”¨æˆ·ç¾¤ä½“**ï¼šæ”¿æ²»åˆ›ä¼¤å¹¸å­˜è€…ã€éš¾æ°‘ã€å¼‚è®®äººå£«

**ç”¨æˆ·ç”»åƒ**ï¼š

- å¹´é¾„ï¼š18-65å²
- èƒŒæ™¯ï¼šç»å†æ”¿æ²»è¿«å®³ã€æµäº¡ã€æ–‡åŒ–é€‚åº”å›°éš¾
- ç—›ç‚¹ï¼šè¯­è¨€éšœç¢ã€æ–‡åŒ–éš”é˜‚ã€å¿ƒç†åˆ›ä¼¤ã€ç¼ºä¹ä¿¡ä»»æ„Ÿ
- éœ€æ±‚ï¼šéšæ—¶å¯ç”¨çš„æƒ…æ„Ÿæ”¯æŒã€å®‰å…¨ç§å¯†çš„ç¯å¢ƒã€ä¸“ä¸šè¯„ä¼°

**æ ¸å¿ƒéœ€æ±‚**ï¼š

- éšæ—¶å¯ç”¨çš„æƒ…æ„Ÿæ”¯æŒï¼ˆ24/7 AIå¯¹è¯ï¼‰
- å®‰å…¨ç§å¯†çš„å€¾è¯‰ç¯å¢ƒï¼ˆåŠ å¯†ã€GDPRåˆè§„ï¼‰
- ä¸“ä¸šçš„å¿ƒç†å¥åº·è¯„ä¼°ï¼ˆæ ‡å‡†åŒ–é‡è¡¨ï¼‰
- ä¸åŒ»ç”Ÿçš„ä¾¿æ·æ²Ÿé€šï¼ˆå®æ—¶æ¶ˆæ¯ï¼‰
- å¤šè¯­è¨€æ”¯æŒï¼ˆæ¯è¯­äº¤æµï¼‰

### 2. åŒ»ç”Ÿï¼ˆDoctorï¼‰

**ç›®æ ‡ç”¨æˆ·ç¾¤ä½“**ï¼šå¿ƒç†å¥åº·ä¸“ä¸šäººå£«ã€ä¸´åºŠåŒ»ç”Ÿã€å¿ƒç†å’¨è¯¢å¸ˆ

**ç”¨æˆ·ç”»åƒ**ï¼š

- èƒŒæ™¯ï¼šæŒæœ‰å¿ƒç†å¥åº·ç›¸å…³æ‰§ç…§çš„ä¸“ä¸šäººå£«
- ç—›ç‚¹ï¼šæ‚£è€…æ•°é‡å¤šã€é£é™©ç®¡ç†å›°éš¾ã€æ•°æ®åˆ†æ•£
- éœ€æ±‚ï¼šé«˜æ•ˆæ‚£è€…ç®¡ç†ã€è‡ªåŠ¨åŒ–é£é™©é¢„è­¦ã€AIè¾…åŠ©è¯Šæ–­

**æ ¸å¿ƒéœ€æ±‚**ï¼š

- é«˜æ•ˆçš„æ‚£è€…ç®¡ç†ï¼ˆåˆ—è¡¨ã€æ’åºã€ç­›é€‰ï¼‰
- å®æ—¶é£é™©é¢„è­¦ï¼ˆä¼˜å…ˆçº§é˜Ÿåˆ—ï¼‰
- AIè¾…åŠ©è¯Šæ–­åˆ†æï¼ˆä¸Šä¸‹æ–‡èšåˆï¼‰
- ä¸´åºŠæ•°æ®è¿½è¸ªï¼ˆè¶‹åŠ¿å¯è§†åŒ–ï¼‰
- ä¾¿æ·çš„æ–‡æ¡£ç”Ÿæˆï¼ˆPDFæŠ¥å‘Šï¼‰

### 3. ç®¡ç†å‘˜ï¼ˆAdminï¼‰

**èŒè´£**ï¼š

- ç³»ç»Ÿç®¡ç†
- ç”¨æˆ·ç®¡ç†
- å®¡è®¡æ—¥å¿—æŸ¥çœ‹
- é…ç½®ç®¡ç†

---

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½æ¨¡å—

### æ¨¡å—1ï¼šAIæƒ…æ„Ÿæ”¯æŒå¼•æ“

#### 1.1 æ‚£è€…ä¾§åŠŸèƒ½

**åŠŸèƒ½åç§°**ï¼š24/7 AIå¯¹è¯é™ªä¼´

**æŠ€æœ¯ç‰¹ç‚¹**ï¼š

```
AIå¯¹è¯ç³»ç»Ÿ
â”œâ”€â”€ æµå¼å“åº”ï¼ˆSSEï¼‰ï¼šå®æ—¶å¯¹è¯ä½“éªŒï¼Œé€å­—æ˜¾ç¤º
â”œâ”€â”€ æŒ‰éœ€ä¸Šä¸‹æ–‡åŠ è½½ï¼š84%çš„tokenèŠ‚çœç‡
â”œâ”€â”€ è‡ªåŠ¨é£é™©æ£€æµ‹ï¼šCRITICAL/HIGH/MEDIUM/LOWå››çº§é£é™©è¯†åˆ«
â”œâ”€â”€ å¤šè¯­è¨€æ”¯æŒï¼š12+è¯­è¨€ï¼Œè‡ªåŠ¨æ£€æµ‹ç”¨æˆ·è¯­è¨€
â”œâ”€â”€ å¯¹è¯è®°å¿†ï¼šè·¨ä¼šè¯ä¸Šä¸‹æ–‡ç»´æŠ¤
â””â”€â”€ æƒ…æ„Ÿç†è§£ï¼šä¸“é—¨é’ˆå¯¹æ”¿æ²»åˆ›ä¼¤ä¼˜åŒ–çš„æç¤ºè¯
```

**ç‰¹è‰²ï¼šæ”¿æ²»åˆ›ä¼¤ç‰¹å®šæ£€æµ‹æ¨¡å¼**

- **æµäº¡ç»æœ›ï¼ˆExile despairï¼‰**ï¼šå¯¹å¤±å»ç¥–å›½çš„æ— æœ›æ„Ÿ
- **å¹¸å­˜è€…å†…ç–šï¼ˆSurvivor's guiltï¼‰**ï¼šå¯¹æ¯”åŒä¼´æ›´å¥½å¢ƒé‡çš„æ„§ç–š
- **è¿«å®³ææƒ§ï¼ˆPersecution fearï¼‰**ï¼šå¯¹è¢«è¿½è¸ªã€ç›‘æ§çš„æŒç»­ææƒ§
- **èº«ä»½ä¸¢å¤±ï¼ˆIdentity lossï¼‰**ï¼šæ–‡åŒ–èº«ä»½è®¤åŒå±æœº
- **æ–‡åŒ–é”™ä½ï¼ˆCultural displacementï¼‰**ï¼šé€‚åº”æ–°ç¯å¢ƒçš„å›°éš¾

**ç”¨æˆ·äº¤äº’æµç¨‹**ï¼š

```
1. æ‚£è€…è¿›å…¥èŠå¤©é¡µé¢
   â†“
2. è¾“å…¥æ¶ˆæ¯ï¼ˆæ”¯æŒå¤šè¯­è¨€ï¼‰
   â†“
3. AIæµå¼è¿”å›å“åº”
   â†“
4. åå°è‡ªåŠ¨é£é™©æ£€æµ‹
   â†“
5. å¦‚æ£€æµ‹åˆ°é«˜é£é™© â†’ è‡ªåŠ¨é€šçŸ¥åŒ»ç”Ÿ
   â†“
6. å¯¹è¯è‡ªåŠ¨ä¿å­˜ï¼Œå¯éšæ—¶ç»§ç»­
```

#### 1.2 åŒ»ç”Ÿä¾§åŠŸèƒ½

**åŠŸèƒ½åç§°**ï¼šAIä¸´åºŠåŠ©æ‰‹

**æ ¸å¿ƒèƒ½åŠ›**ï¼š

```
AIåŠ©æ‰‹åŠŸèƒ½
â”œâ”€â”€ æ‚£è€…ä¸Šä¸‹æ–‡èšåˆï¼šè‡ªåŠ¨åŠ è½½ç›¸å…³æ‚£è€…æ•°æ®
â”‚   â”œâ”€â”€ æœ€è¿‘7å¤©check-inæ•°æ®
â”‚   â”œâ”€â”€ æœ€æ–°è¯„ä¼°åˆ†æ•°å’Œè¶‹åŠ¿
â”‚   â”œâ”€â”€ é£é™©äº‹ä»¶å†å²
â”‚   â””â”€â”€ AIå¯¹è¯æ‘˜è¦
â”œâ”€â”€ è¶‹åŠ¿åˆ†æï¼šæƒ…ç»ªæ³¢åŠ¨ã€ç¡çœ æ¨¡å¼è¯†åˆ«
â”œâ”€â”€ é£é™©è¯„ä¼°ï¼šå†å²é£é™©äº‹ä»¶åˆ†æ
â”œâ”€â”€ å¯¹è¯å†å²è®¿é—®ï¼šæ‚£è€…-AIå¯¹è¯å®Œæ•´è®°å½•
â””â”€â”€ ä¸´åºŠå»ºè®®ï¼šAIç”Ÿæˆçš„è¯Šæ–­è§è§£å’Œæ²»ç–—å»ºè®®
```

**ä½¿ç”¨åœºæ™¯**ï¼š

- å°±è¯Šå‰å‡†å¤‡ï¼šå¿«é€Ÿäº†è§£æ‚£è€…è¿‘æœŸçŠ¶æ€
- ç–‘éš¾æ¡ˆä¾‹è®¨è®ºï¼šAIæä¾›ç¬¬äºŒæ„è§
- æ²»ç–—æ–¹æ¡ˆåˆ¶å®šï¼šåŸºäºæ•°æ®çš„å»ºè®®

---

### æ¨¡å—2ï¼šå¥åº·æ•°æ®è¿½è¸ª

#### 2.1 æ¯æ—¥ç­¾åˆ°ï¼ˆDaily Check-inï¼‰

**æ•°æ®æ”¶é›†é¡¹**ï¼š

| æ•°æ®é¡¹     | æ ¼å¼ | èŒƒå›´                 | ç”¨é€”             |
| ---------- | ---- | -------------------- | ---------------- |
| æƒ…ç»ªè¯„åˆ†   | æ•°å€¼ | 0-10åˆ†               | è¿½è¸ªæƒ…ç»ªæ³¢åŠ¨è¶‹åŠ¿ |
| ç¡çœ æ—¶é•¿   | æ•°å€¼ | å°æ—¶æ•°               | ç›‘æµ‹ç¡çœ æ¨¡å¼     |
| ç¡çœ è´¨é‡   | æšä¸¾ | å¾ˆå·®/å·®/ä¸€èˆ¬/å¥½/å¾ˆå¥½ | è¯„ä¼°ä¼‘æ¯è´¨é‡     |
| æœè¯ä¾ä»æ€§ | å¸ƒå°” | æ˜¯/å¦                | ç¡®ä¿æ²»ç–—æ‰§è¡Œ     |

**æ•°æ®å¯è§†åŒ–**ï¼š

- 7å¤©/30å¤©æƒ…ç»ªè¶‹åŠ¿å›¾
- ç¡çœ æ—¶é•¿æŸ±çŠ¶å›¾
- æœè¯ä¾ä»æ€§æ—¥å†çƒ­åŠ›å›¾

**è®¾è®¡è€ƒè™‘**ï¼š

- ç®€åŒ–è¾“å…¥ï¼šä½¿ç”¨æ»‘å—ã€å•é€‰æŒ‰é’®
- æ¯æ—¥æé†’ï¼šå¯é…ç½®çš„é€šçŸ¥æ—¶é—´
- è¡¥è®°åŠŸèƒ½ï¼šå¯è¡¥å¡«è¿‡å»7å¤©çš„æ•°æ®

#### 2.2 å¿ƒç†è¯„ä¼°é‡è¡¨

**æ”¯æŒçš„é‡è¡¨**ï¼š

| é‡è¡¨      | å…¨ç§°                           | é¢˜ç›®æ•° | ç”¨é€”         | ä¸¥é‡ç¨‹åº¦åˆ†çº§                                            |
| --------- | ------------------------------ | ------ | ------------ | ------------------------------------------------------- |
| **PHQ-9** | Patient Health Questionnaire-9 | 9é¢˜    | æŠ‘éƒç—‡ç­›æŸ¥   | æ— (0-4)/è½»åº¦(5-9)/ä¸­åº¦(10-14)/ä¸­é‡åº¦(15-19)/é‡åº¦(20-27) |
| **GAD-7** | Generalized Anxiety Disorder-7 | 7é¢˜    | ç„¦è™‘ç—‡ç­›æŸ¥   | æ— (0-4)/è½»åº¦(5-9)/ä¸­åº¦(10-14)/é‡åº¦(15-21)               |
| **PSS**   | Perceived Stress Scale         | 10é¢˜   | å‹åŠ›æ„ŸçŸ¥è¯„ä¼° | ä½(0-13)/ä¸­(14-26)/é«˜(27-40)                            |
| **ISI**   | Insomnia Severity Index        | 7é¢˜    | å¤±çœ ä¸¥é‡ç¨‹åº¦ | æ— (0-7)/äºšä¸´åºŠ(8-14)/ä¸­åº¦(15-21)/é‡åº¦(22-28)            |
| **PCL-5** | PTSD Checklist for DSM-5       | 20é¢˜   | PTSDç­›æŸ¥     | é˜ˆå€¼â‰¥33æç¤ºå¯èƒ½PTSD                                     |

**è¯„ä¼°æµç¨‹**ï¼š

```
1. åŒ»ç”Ÿæˆ–æ‚£è€…å‘èµ·è¯„ä¼°
   â†“
2. æ‚£è€…å¡«å†™é—®å·ï¼ˆå•é¡µæˆ–åˆ†é¡µï¼‰
   â†“
3. è‡ªåŠ¨è®¡ç®—æ€»åˆ†
   â†“
4. ç”Ÿæˆä¸¥é‡ç¨‹åº¦ç­‰çº§
   â†“
5. ä¿å­˜åˆ°æ•°æ®åº“
   â†“
6. å¯æŸ¥çœ‹å†å²è¯„ä¼°è¶‹åŠ¿
```

**æ•°æ®åº”ç”¨**ï¼š

- è¯Šæ–­å‚è€ƒ
- æ²»ç–—æ•ˆæœè¯„ä¼°
- é£é™©é¢„è­¦è¾…åŠ©æ•°æ®
- AIåŠ©æ‰‹åˆ†æè¾“å…¥

---

### æ¨¡å—3ï¼šé£é™©æ£€æµ‹ä¸é¢„è­¦

#### 3.1 é£é™©ç­‰çº§å®šä¹‰

| ç­‰çº§         | åˆ†å€¼ | æè¿°     | ç¤ºä¾‹                             | å¤„ç†æ–¹å¼                       |
| ------------ | ---- | -------- | -------------------------------- | ------------------------------ |
| **CRITICAL** | 4    | å³åˆ»å±é™© | "ä»Šæ™šå°±æƒ³ç»“æŸç”Ÿå‘½ï¼Œå·²å‡†å¤‡å¥½è®¡åˆ’" | ç´§æ€¥åŒ»ç”Ÿé€šçŸ¥ï¼ˆçŸ­ä¿¡+é‚®ä»¶+ç³»ç»Ÿï¼‰ |
| **HIGH**     | 3    | ä¸¥é‡æ‹…å¿§ | "æƒ³æ­»ã€è§‰å¾—æ´»ç€æ²¡æ„ä¹‰"           | ä¼˜å…ˆçº§é€šçŸ¥ï¼ˆé‚®ä»¶+ç³»ç»Ÿï¼‰        |
| **MEDIUM**   | 2    | éœ€è¦å…³æ³¨ | "åŒä¸–ã€æŒç»­ä½è½æƒ…ç»ª"             | å¸¸è§„é€šçŸ¥ï¼ˆç³»ç»Ÿï¼‰               |
| **LOW**      | 1    | è½»å¾®è¿¹è±¡ | è´Ÿé¢æƒ…ç»ªè¡¨è¾¾                     | è®°å½•è§‚å¯Ÿï¼ˆæ— é€šçŸ¥ï¼‰             |

#### 3.2 é£é™©ç±»å‹

| ç±»å‹     | è‹±æ–‡æ ‡è¯†         | æ£€æµ‹å†…å®¹                 | ç‰¹å®šäºæ”¿æ²»åˆ›ä¼¤ |
| -------- | ---------------- | ------------------------ | -------------- |
| è‡ªæ€é£é™© | SUICIDAL         | è‡ªæ€æ„å¿µã€è®¡åˆ’ã€æ‰‹æ®µ     | âŒ             |
| è‡ªæ®‹è¡Œä¸º | SELF_HARM        | è‡ªæˆ‘ä¼¤å®³è¡Œä¸º             | âŒ             |
| æš´åŠ›å€¾å‘ | VIOLENCE         | æ”»å‡»ä»–äººçš„æƒ³æ³•æˆ–è®¡åˆ’     | âŒ             |
| è¿«å®³ææƒ§ | PERSECUTION_FEAR | è¢«è¿½è¸ªã€ç›‘æ§ã€æŠ¥å¤çš„ææƒ§ | âœ…             |
| å…¶ä»–é£é™© | OTHER            | å…¶ä»–å¿ƒç†å¥åº·é£é™©         | âŒ             |

#### 3.3 æ£€æµ‹æŠ€æœ¯

**æ··åˆæ£€æµ‹ç­–ç•¥**ï¼š

```python
def detect_risk(text: str) -> RiskResult:
    # ç¬¬ä¸€æ­¥ï¼šåŸºäºè§„åˆ™çš„å¿«é€Ÿæ£€æµ‹ï¼ˆæ¯«ç§’çº§ï¼‰
    rule_result = rule_based_detect(text)

    # ç¬¬äºŒæ­¥ï¼šå¦‚æœè§„åˆ™è§¦å‘é«˜é£é™©ï¼Œä½¿ç”¨LLMéªŒè¯ï¼ˆç§’çº§ï¼‰
    if rule_result.level >= HIGH:
        llm_result = llm_verify_with_claude(text)
        return merge_results(rule_result, llm_result)

    return rule_result
```

**å¤šè¯­è¨€æ”¯æŒ**ï¼š

- ä¸­æ–‡ï¼ˆzhï¼‰
- è‹±è¯­ï¼ˆenï¼‰
- æ³¢æ–¯è¯­ï¼ˆfaï¼‰
- åœŸè€³å…¶è¯­ï¼ˆtrï¼‰
- è¥¿ç­ç‰™è¯­ï¼ˆesï¼‰

**æ£€æµ‹ç½®ä¿¡åº¦**ï¼š

- æ¯ä¸ªé£é™©äº‹ä»¶åŒ…å«ç½®ä¿¡åº¦åˆ†æ•°ï¼ˆ0.0-1.0ï¼‰
- ç½®ä¿¡åº¦ > 0.8ï¼šé«˜å¯ä¿¡åº¦
- ç½®ä¿¡åº¦ 0.5-0.8ï¼šä¸­ç­‰å¯ä¿¡åº¦
- ç½®ä¿¡åº¦ < 0.5ï¼šä½å¯ä¿¡åº¦ï¼ˆå¯èƒ½è¯¯æŠ¥ï¼‰

#### 3.4 åŒ»ç”Ÿé£é™©é˜Ÿåˆ—

**é˜Ÿåˆ—æ’åºé€»è¾‘**ï¼š

```
æ’åºä¼˜å…ˆçº§ï¼š
1. é£é™©ç­‰çº§ï¼ˆCRITICAL > HIGH > MEDIUM > LOWï¼‰
2. æœªå®¡æŸ¥çŠ¶æ€ä¼˜å…ˆ
3. åˆ›å»ºæ—¶é—´ï¼ˆæœ€æ–°ä¼˜å…ˆï¼‰
```

**åŒ»ç”Ÿæ“ä½œ**ï¼š

- æŸ¥çœ‹é£é™©è¯¦æƒ…ï¼ˆè§¦å‘å¯¹è¯ä¸Šä¸‹æ–‡ï¼‰
- æ ‡è®°ä¸ºå·²å®¡æŸ¥
- ç›´æ¥å‘é€æ¶ˆæ¯ç»™æ‚£è€…
- åˆ›å»ºç´§æ€¥é¢„çº¦

---

### æ¨¡å—4ï¼šåŒ»æ‚£åä½œç³»ç»Ÿ

#### 4.1 è¿æ¥ç®¡ç†

**è¿æ¥æµç¨‹**ï¼š

```
æ­¥éª¤1ï¼šåŒ»ç”Ÿå‘é€è¿æ¥è¯·æ±‚
  â”œâ”€â”€ å¡«å†™å¤‡æ³¨ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰
  â””â”€â”€ ç³»ç»Ÿåˆ›å»ºå¾…å¤„ç†è¯·æ±‚

æ­¥éª¤2ï¼šæ‚£è€…æ”¶åˆ°é€šçŸ¥
  â”œâ”€â”€ æŸ¥çœ‹åŒ»ç”Ÿèµ„æ–™ï¼ˆä¸“ä¸šã€è¯Šæ‰€ã€ç®€ä»‹ï¼‰
  â””â”€â”€ é€‰æ‹©æ¥å—æˆ–æ‹’ç»

æ­¥éª¤3ï¼šè¿æ¥å»ºç«‹
  â”œâ”€â”€ æ¥å— â†’ å»ºç«‹åŒ»æ‚£å…³ç³»
  â”‚   â”œâ”€â”€ æ‚£è€…è·å¾—ä¸»æ²»åŒ»ç”Ÿ
  â”‚   â”œâ”€â”€ åŒ»ç”Ÿè·å¾—æ‚£è€…æ•°æ®è®¿é—®æƒ
  â”‚   â””â”€â”€ è§£é”æ¶ˆæ¯ã€é¢„çº¦ç­‰åŠŸèƒ½
  â””â”€â”€ æ‹’ç» â†’ è¯·æ±‚å…³é—­

æ­¥éª¤4ï¼šè¿æ¥è§£é™¤ï¼ˆå¯é€‰ï¼‰
  â””â”€â”€ æ‚£è€…å¯ä¸»åŠ¨æ–­å¼€ä¸åŒ»ç”Ÿçš„è¿æ¥
```

**æƒé™æ§åˆ¶**ï¼š

- æœªè¿æ¥ï¼šåŒ»ç”Ÿæ— æ³•æŸ¥çœ‹æ‚£è€…è¯¦ç»†æ•°æ®
- å·²è¿æ¥ï¼šåŒ»ç”Ÿå¯è®¿é—®æ‚£è€…æ‰€æœ‰ä¸´åºŠæ•°æ®
- è§£é™¤åï¼šåŒ»ç”Ÿå¤±å»è®¿é—®æƒé™ï¼Œå†å²æ•°æ®ä¿ç•™

#### 4.2 å®æ—¶é€šä¿¡ç³»ç»Ÿ

**æŠ€æœ¯æ¶æ„**ï¼š

- **åè®®**ï¼šWebSocketï¼ˆåŒå‘å®æ—¶é€šä¿¡ï¼‰
- **å¿ƒè·³**ï¼š30ç§’é—´éš”ï¼Œç¡®ä¿è¿æ¥æ´»è·ƒ
- **é‡è¿**ï¼šå®¢æˆ·ç«¯è‡ªåŠ¨é‡è¿æœºåˆ¶
- **æ¶ˆæ¯é˜Ÿåˆ—**ï¼šç¦»çº¿æ¶ˆæ¯æš‚å­˜

**åŠŸèƒ½ç‰¹æ€§**ï¼š

| åŠŸèƒ½     | æè¿°              | æŠ€æœ¯å®ç°          |
| -------- | ----------------- | ----------------- |
| æ–‡æœ¬æ¶ˆæ¯ | æ”¯æŒMarkdownæ ¼å¼  | WebSocketæ¨é€     |
| å›¾ç‰‡å‘é€ | JPG/PNGï¼Œæœ€å¤§10MB | S3å­˜å‚¨+ç¼©ç•¥å›¾     |
| æ–‡ä»¶é™„ä»¶ | PDF/DOCï¼Œæœ€å¤§10MB | S3å­˜å‚¨+ä¸‹è½½é“¾æ¥   |
| æœªè¯»ç»Ÿè®¡ | å®æ—¶æœªè¯»æ¶ˆæ¯æ•°    | Redisè®¡æ•°å™¨       |
| å·²è¯»å›æ‰§ | æ¶ˆæ¯å·²è¯»çŠ¶æ€      | WebSocketäº‹ä»¶     |
| è¾“å…¥çŠ¶æ€ | "æ­£åœ¨è¾“å…¥..."æç¤º | WebSocketä¸´æ—¶äº‹ä»¶ |

**æ¶ˆæ¯çº¿ç¨‹ï¼ˆThreadï¼‰**ï¼š

- æ¯å¯¹åŒ»æ‚£å…³ç³»ä¸€ä¸ªç‹¬ç«‹çº¿ç¨‹
- çº¿ç¨‹åŒ…å«ï¼šæœ€åæ¶ˆæ¯æ—¶é—´ã€æœªè¯»è®¡æ•°ã€å‚ä¸è€…ä¿¡æ¯
- æŒ‰æœ€åæ¶ˆæ¯æ—¶é—´æ’åº

#### 4.3 é¢„çº¦ç®¡ç†ç³»ç»Ÿ

**é¢„çº¦åˆ›å»ºï¼ˆåŒ»ç”Ÿï¼‰**ï¼š

```
è¾“å…¥å­—æ®µï¼š
â”œâ”€â”€ æ‚£è€…é€‰æ‹©ï¼ˆä¸‹æ‹‰åˆ—è¡¨ï¼‰
â”œâ”€â”€ é¢„çº¦æ—¥æœŸæ—¶é—´
â”œâ”€â”€ é¢„çº¦ç±»å‹ï¼ˆé¦–è¯Š/å¤è¯Š/ç´§æ€¥ï¼‰
â”œâ”€â”€ æŒç»­æ—¶é—´ï¼ˆ15/30/45/60åˆ†é’Ÿï¼‰
â””â”€â”€ å¤‡æ³¨è¯´æ˜
```

**é¢„çº¦çŠ¶æ€æœº**ï¼š

```
PENDINGï¼ˆå¾…ç¡®è®¤ï¼‰
  â”œâ”€â”€ CONFIRMEDï¼ˆå·²ç¡®è®¤ï¼‰
  â”‚   â”œâ”€â”€ COMPLETEDï¼ˆå·²å®Œæˆï¼‰
  â”‚   â””â”€â”€ CANCELLEDï¼ˆå·²å–æ¶ˆï¼‰
  â””â”€â”€ CANCELLEDï¼ˆå·²å–æ¶ˆï¼‰
```

**åŠŸèƒ½åˆ—è¡¨**ï¼š

| è§’è‰² | åŠŸèƒ½     | æè¿°                              |
| ---- | -------- | --------------------------------- |
| åŒ»ç”Ÿ | åˆ›å»ºé¢„çº¦ | æŒ‡å®šæ—¶é—´ã€æ‚£è€…ã€ç±»å‹              |
| åŒ»ç”Ÿ | ç¡®è®¤é¢„çº¦ | PENDING â†’ CONFIRMED               |
| åŒ»ç”Ÿ | å®Œæˆé¢„çº¦ | CONFIRMED â†’ COMPLETEDï¼Œå¯æ·»åŠ æ€»ç»“ |
| åŒ»ç”Ÿ | å–æ¶ˆé¢„çº¦ | ä»»ä½•çŠ¶æ€ â†’ CANCELLED              |
| åŒ»ç”Ÿ | æ—¥å†è§†å›¾ | æœˆè§†å›¾ã€å‘¨è§†å›¾ã€æ—¥è§†å›¾            |
| æ‚£è€… | æŸ¥çœ‹é¢„çº¦ | æŸ¥çœ‹è‡ªå·±çš„æ‰€æœ‰é¢„çº¦                |
| æ‚£è€… | å–æ¶ˆé¢„çº¦ | ä»…é™PENDING/CONFIRMEDçŠ¶æ€         |
| æ‚£è€… | æ·»åŠ å¤‡æ³¨ | å°±è¯Šå‰å¤‡æ³¨ã€é—®é¢˜åˆ—è¡¨              |
| ç³»ç»Ÿ | æé†’é€šçŸ¥ | é¢„çº¦å‰24å°æ—¶ã€1å°æ—¶æé†’           |

**æ—¥å†é›†æˆ**ï¼š

- iCalendaræ ¼å¼å¯¼å‡º
- é¢œè‰²ç¼–ç ï¼ˆç±»å‹ã€çŠ¶æ€ï¼‰
- æ—¶åŒºå¤„ç†

---

### æ¨¡å—5ï¼šæŠ¥å‘Šç”Ÿæˆä¸æ•°æ®å¯¼å‡º

#### 5.1 å°±è¯Šå‰æ‘˜è¦ï¼ˆPre-visit Summaryï¼‰

**ç”Ÿæˆæ—¶æœº**ï¼š

- åŒ»ç”Ÿæ‰‹åŠ¨è§¦å‘
- é¢„çº¦å‰è‡ªåŠ¨ç”Ÿæˆï¼ˆå¯é…ç½®ï¼‰

**æŠ¥å‘Šå†…å®¹ç»“æ„**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å°±è¯Šå‰æ‚£è€…æ‘˜è¦æŠ¥å‘Š                 â”‚
â”‚   Patient Pre-Visit Summary          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç¬¬1éƒ¨åˆ†ï¼šåŸºæœ¬ä¿¡æ¯                    â”‚
â”‚   - æ‚£è€…å§“åã€å¹´é¾„ã€æ€§åˆ«              â”‚
â”‚   - åŒ»ç”Ÿå§“åã€ç”Ÿæˆæ—¥æœŸ                â”‚
â”‚   - æ‚£è€…èƒŒæ™¯æ‘˜è¦                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç¬¬2éƒ¨åˆ†ï¼šè¿‘æœŸå¥åº·æ•°æ®ï¼ˆ7-30å¤©ï¼‰       â”‚
â”‚   - æƒ…ç»ªè¯„åˆ†è¶‹åŠ¿å›¾                    â”‚
â”‚   - å¹³å‡ç¡çœ æ—¶é•¿ç»Ÿè®¡                  â”‚
â”‚   - æœè¯ä¾ä»æ€§ç™¾åˆ†æ¯”                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç¬¬3éƒ¨åˆ†ï¼šå¿ƒç†è¯„ä¼°ç»“æœ                â”‚
â”‚   - æœ€æ–°è¯„ä¼°åˆ†æ•°ï¼ˆPHQ-9/GAD-7ç­‰ï¼‰     â”‚
â”‚   - ä¸ä¸Šæ¬¡è¯„ä¼°å¯¹æ¯”                    â”‚
â”‚   - ä¸¥é‡ç¨‹åº¦ç­‰çº§                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç¬¬4éƒ¨åˆ†ï¼šé£é™©äº‹ä»¶å†å²                â”‚
â”‚   - é£é™©äº‹ä»¶åˆ—è¡¨ï¼ˆç­‰çº§ã€æ—¶é—´ã€æè¿°ï¼‰  â”‚
â”‚   - æœªå®¡æŸ¥çš„é£é™©äº‹ä»¶é«˜äº®              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç¬¬5éƒ¨åˆ†ï¼šAIå¯¹è¯æ´å¯Ÿ                  â”‚
â”‚   - è¿‘æœŸå¯¹è¯ä¸»é¢˜æ‘˜è¦                  â”‚
â”‚   - å…³é”®æƒ…ç»ªè¯æ±‡æå–                  â”‚
â”‚   - æ‚£è€…å…³æ³¨ç‚¹åˆ†æ                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç¬¬6éƒ¨åˆ†ï¼šAIä¸´åºŠå»ºè®®                  â”‚
â”‚   - è¯Šæ–­å‡è®¾                          â”‚
â”‚   - å»ºè®®çš„å¹²é¢„æªæ–½                    â”‚
â”‚   - éœ€è¦å…³æ³¨çš„é—®é¢˜                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æŠ€æœ¯å®ç°**ï¼š

- **PDFå¼•æ“**ï¼šReportLab
- **å›¾è¡¨ç”Ÿæˆ**ï¼šmatplotlib â†’ åµŒå…¥PDF
- **å­˜å‚¨**ï¼šS3/MinIO
- **ä¸‹è½½é“¾æ¥**ï¼šå¸¦ç­¾åçš„ä¸´æ—¶URLï¼ˆ24å°æ—¶æœ‰æ•ˆï¼‰

#### 5.2 æ•°æ®å¯¼å‡ºï¼ˆGDPRåˆè§„ï¼‰

**å¯¼å‡ºæ ¼å¼**ï¼š

| æ ¼å¼     | å†…å®¹                               | é€‚ç”¨åœºæ™¯           |
| -------- | ---------------------------------- | ------------------ |
| **JSON** | å®Œæ•´ç»“æ„åŒ–æ•°æ®                     | æŠ€æœ¯ç”¨æˆ·ã€æ•°æ®è¿ç§» |
| **CSV**  | è¡¨æ ¼æ•°æ®ï¼ˆcheck-ins, assessmentsï¼‰ | Excelåˆ†æ          |
| **PDF**  | äººç±»å¯è¯»æŠ¥å‘Š                       | æ‰“å°ã€å­˜æ¡£         |

**å¯é€‰å¯¼å‡ºå†…å®¹**ï¼š

```
[ ] ä¸ªäººèµ„æ–™ä¿¡æ¯
[ ] AIå¯¹è¯å†å²
[ ] æ¯æ—¥ç­¾åˆ°æ•°æ®
[ ] å¿ƒç†è¯„ä¼°è®°å½•
[ ] é£é™©äº‹ä»¶è®°å½•
[ ] åŒ»æ‚£æ¶ˆæ¯è®°å½•
[ ] é¢„çº¦è®°å½•
[ ] ä¸´åºŠç¬”è®°
```

**å®‰å…¨æ§åˆ¶**ï¼š

- **é¢‘ç‡é™åˆ¶**ï¼š24å°æ—¶å†…æœ€å¤š1æ¬¡è¯·æ±‚
- **èº«ä»½éªŒè¯**ï¼šéœ€è¾“å…¥å¯†ç äºŒæ¬¡ç¡®è®¤
- **ä¸‹è½½ä»¤ç‰Œ**ï¼šä¸€æ¬¡æ€§ä¸‹è½½tokenï¼Œ24å°æ—¶æœ‰æ•ˆ
- **å®¡è®¡æ—¥å¿—**ï¼šè®°å½•æ‰€æœ‰å¯¼å‡ºæ“ä½œ

**å¯¼å‡ºæµç¨‹**ï¼š

```
1. ç”¨æˆ·è¯·æ±‚å¯¼å‡º
   â†“
2. è¾“å…¥å¯†ç éªŒè¯
   â†“
3. é€‰æ‹©å¯¼å‡ºæ ¼å¼å’Œå†…å®¹
   â†“
4. åˆ›å»ºå¼‚æ­¥ä»»åŠ¡
   â†“
5. åå°ç”Ÿæˆæ–‡ä»¶ï¼ˆå¯èƒ½éœ€è¦å‡ åˆ†é’Ÿï¼‰
   â†“
6. ç”Ÿæˆä¸‹è½½ä»¤ç‰Œ
   â†“
7. ç”¨æˆ·æ”¶åˆ°é€šçŸ¥
   â†“
8. ç‚¹å‡»ä¸‹è½½é“¾æ¥ï¼ˆ24å°æ—¶å†…æœ‰æ•ˆï¼‰
```

---

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

### ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ç”¨æˆ·å±‚                                â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚    â”‚ æ‚£è€…Web  â”‚  â”‚ åŒ»ç”ŸWeb  â”‚  â”‚ ç§»åŠ¨PWA  â”‚                 â”‚
â”‚    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚             â”‚             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å‰ç«¯å±‚                                â”‚
â”‚              Next.js 14 + TypeScript                         â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚    â”‚  App Router + Server Components + RSC       â”‚         â”‚
â”‚    â”‚  Zustand State + React Query                 â”‚         â”‚
â”‚    â”‚  Tailwind CSS + Radix UI                     â”‚         â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ REST API / WebSocket
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       è´Ÿè½½å‡è¡¡å±‚                              â”‚
â”‚                    Nginx / ALB                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                â”‚                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
â”‚  Backend 1   â”‚  â”‚  Backend 2  â”‚  â”‚  Backend N  â”‚
â”‚  FastAPI     â”‚  â”‚  FastAPI    â”‚  â”‚  FastAPI    â”‚
â”‚  + Uvicorn   â”‚  â”‚  + Uvicorn  â”‚  â”‚  + Uvicorn  â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
      â”‚                 â”‚                 â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   æœåŠ¡å±‚                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚  AIå¼•æ“     â”‚  â”‚  é‚®ä»¶æœåŠ¡    â”‚           â”‚
â”‚  â”‚  - Claude   â”‚  â”‚  - aiosmtplib â”‚           â”‚
â”‚  â”‚  - Context  â”‚  â”‚  - é˜Ÿåˆ—      â”‚           â”‚
â”‚  â”‚  - Risk     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚  å­˜å‚¨æœåŠ¡   â”‚  â”‚  WebSocket   â”‚           â”‚
â”‚  â”‚  - S3/MinIO â”‚  â”‚  ç®¡ç†å™¨      â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   æ•°æ®å±‚                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ PostgreSQL  â”‚  â”‚   Redis     â”‚            â”‚
â”‚  â”‚  (Primary)  â”‚  â”‚  - ä¼šè¯     â”‚            â”‚
â”‚  â”‚  - ä¸šåŠ¡æ•°æ® â”‚  â”‚  - ç¼“å­˜     â”‚            â”‚
â”‚  â”‚  - å®¡è®¡æ—¥å¿— â”‚  â”‚  - é˜Ÿåˆ—     â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚         â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ PostgreSQL  â”‚  â”‚  MinIO/S3   â”‚            â”‚
â”‚  â”‚  (Replica)  â”‚  â”‚  - æ–‡ä»¶     â”‚            â”‚
â”‚  â”‚  - è¯»åˆ†ç¦»   â”‚  â”‚  - æŠ¥å‘Š     â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  å¤–éƒ¨æœåŠ¡                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ Anthropic    â”‚  â”‚  SMTP Server â”‚          â”‚
â”‚  â”‚  Claude API  â”‚  â”‚  (Gmailç­‰)   â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æŠ€æœ¯æ ˆè¯¦è§£

#### åç«¯æŠ€æœ¯æ ˆ

| å±‚çº§           | æŠ€æœ¯             | ç‰ˆæœ¬     | é€‰æ‹©ç†ç”±                    |
| -------------- | ---------------- | -------- | --------------------------- |
| **Webæ¡†æ¶**    | FastAPI          | 0.109.2  | é«˜æ€§èƒ½å¼‚æ­¥æ¡†æ¶ï¼Œè‡ªåŠ¨APIæ–‡æ¡£ |
| **ASGIæœåŠ¡å™¨** | Uvicorn          | 0.27.1   | ç”Ÿäº§çº§ASGIæœåŠ¡å™¨            |
| **ORM**        | SQLAlchemy       | 2.0.25   | å¼ºå¤§çš„å¼‚æ­¥ORMï¼Œæ”¯æŒå¤æ‚æŸ¥è¯¢ |
| **æ•°æ®åº“**     | PostgreSQL       | 15       | ä¼ä¸šçº§å…³ç³»æ•°æ®åº“ï¼ŒJSONæ”¯æŒ  |
| **ç¼“å­˜**       | Redis            | 7        | é«˜æ€§èƒ½å†…å­˜æ•°æ®åº“            |
| **å¯¹è±¡å­˜å‚¨**   | MinIO/S3         | -        | å¯æ‰©å±•çš„æ–‡ä»¶å­˜å‚¨            |
| **AIå¼•æ“**     | Anthropic Claude | >=0.40.0 | å…ˆè¿›çš„LLMï¼Œæ”¯æŒå·¥å…·è°ƒç”¨     |
| **è®¤è¯**       | python-jose      | 3.3.0    | JWT tokenç”Ÿæˆå’ŒéªŒè¯         |
| **å¯†ç å“ˆå¸Œ**   | passlib + bcrypt | 1.7.4    | å®‰å…¨çš„å¯†ç å­˜å‚¨              |
| **PDFç”Ÿæˆ**    | ReportLab        | 4.0.8    | å¼ºå¤§çš„PDFç”Ÿæˆåº“             |
| **é‚®ä»¶**       | aiosmtplib       | 3.0.1    | å¼‚æ­¥SMTPå®¢æˆ·ç«¯              |
| **åŒå› ç´ è®¤è¯** | PyOTP            | 2.9.0    | TOTPå®ç°                    |
| **æ•°æ®éªŒè¯**   | Pydantic         | 2.x      | å¼ºç±»å‹æ•°æ®éªŒè¯              |

#### å‰ç«¯æŠ€æœ¯æ ˆ

| å±‚çº§         | æŠ€æœ¯                 | ç‰ˆæœ¬   | é€‰æ‹©ç†ç”±               |
| ------------ | -------------------- | ------ | ---------------------- |
| **æ¡†æ¶**     | Next.js              | 14.1   | Reactå…¨æ ˆæ¡†æ¶ï¼ŒSSR/SSG |
| **è¯­è¨€**     | TypeScript           | 5.3.3  | ç±»å‹å®‰å…¨ï¼Œå‡å°‘bug      |
| **UIæ ·å¼**   | Tailwind CSS         | 3.4.1  | å®ç”¨ä¼˜å…ˆçš„CSSæ¡†æ¶      |
| **ç»„ä»¶åº“**   | Radix UI             | -      | æ— éšœç¢ã€å¯å®šåˆ¶ç»„ä»¶     |
| **åŠ¨ç”»**     | Framer Motion        | -      | æµç•…çš„åŠ¨ç”»æ•ˆæœ         |
| **çŠ¶æ€ç®¡ç†** | Zustand              | 4.5.0  | è½»é‡çº§ã€ç®€å•çš„çŠ¶æ€ç®¡ç† |
| **å›½é™…åŒ–**   | next-intl            | 4.5.8  | Next.jså›½é™…åŒ–æ–¹æ¡ˆ      |
| **PWA**      | @ducanh2912/next-pwa | 10.2.9 | PWAç¦»çº¿æ”¯æŒ            |
| **è¡¨å•**     | React Hook Form      | -      | é«˜æ€§èƒ½è¡¨å•åº“           |
| **å›¾è¡¨**     | Recharts             | -      | Reactå›¾è¡¨åº“            |

#### DevOpsæŠ€æœ¯æ ˆ

| ç±»åˆ«           | æŠ€æœ¯             | ç”¨é€”                   |
| -------------- | ---------------- | ---------------------- |
| **å®¹å™¨åŒ–**     | Docker           | åº”ç”¨æ‰“åŒ…ã€ç¯å¢ƒä¸€è‡´æ€§   |
| **ç¼–æ’**       | Docker Compose   | æœ¬åœ°å¼€å‘ç¯å¢ƒ           |
| **CI/CD**      | GitHub Actions   | è‡ªåŠ¨åŒ–æµ‹è¯•ã€æ„å»ºã€éƒ¨ç½² |
| **ä»£ç æ ¼å¼åŒ–** | Black, Prettier  | ç»Ÿä¸€ä»£ç é£æ ¼           |
| **ä»£ç æ£€æŸ¥**   | flake8, ESLint   | ä»£ç è´¨é‡æ£€æŸ¥           |
| **ç±»å‹æ£€æŸ¥**   | mypy, TypeScript | é™æ€ç±»å‹åˆ†æ           |
| **å®‰å…¨æ‰«æ**   | Bandit, Safety   | æ¼æ´æ£€æµ‹               |
| **æµ‹è¯•**       | pytest, Jest     | å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•     |
| **è´Ÿè½½æµ‹è¯•**   | Locust           | æ€§èƒ½å‹æµ‹               |

---

### æ ¸å¿ƒæŠ€æœ¯åˆ›æ–°

#### åˆ›æ–°1ï¼šå³æ—¶ä¸Šä¸‹æ–‡åŠ è½½ï¼ˆJust-in-Time Contextï¼‰

**é—®é¢˜èƒŒæ™¯**ï¼š
ä¼ ç»ŸAIå¯¹è¯ç³»ç»Ÿåœ¨æ¯æ¬¡è¯·æ±‚æ—¶éƒ½åŠ è½½å®Œæ•´çš„ç”¨æˆ·å†å²æ•°æ®ï¼Œå¯¼è‡´ï¼š

- é«˜tokenæ¶ˆè€—ï¼ˆæ¯æ¬¡è¯·æ±‚10,000+ tokensï¼‰
- é«˜æˆæœ¬ï¼ˆClaude APIæŒ‰tokenè®¡è´¹ï¼‰
- æ…¢å“åº”ï¼ˆå¤§é‡ä¸Šä¸‹æ–‡å¤„ç†æ—¶é—´é•¿ï¼‰

**ä¼ ç»Ÿæ–¹æ³•**ï¼š

```
æ¯æ¬¡APIè°ƒç”¨ï¼š
[ç³»ç»Ÿæç¤º 500 tokens] +
[æ‚£è€…å®Œæ•´èµ„æ–™ 2000 tokens] +
[æ‰€æœ‰å†å²å¯¹è¯ 5000 tokens] +
[æ‰€æœ‰è¯„ä¼°è®°å½• 2000 tokens] +
[ç”¨æˆ·å½“å‰æ¶ˆæ¯ 500 tokens]
= æ€»è®¡ 10,000 tokens
```

**Heart Guardian AIåˆ›æ–°æ–¹æ¡ˆ**ï¼š

```python
# ç¬¬1æ­¥ï¼šè½»é‡çº§åˆå§‹è¯·æ±‚
initial_request = {
    "system": "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å¿ƒç†å¥åº·AIåŠ©æ‰‹...",  # 500 tokens
    "user_message": "æˆ‘ä»Šå¤©æ„Ÿè§‰å¾ˆç³Ÿç³•",  # 50 tokens
    "tools": [
        "get_recent_checkins",    # å·¥å…·å®šä¹‰
        "get_assessment_history",
        "get_conversation_summary"
    ]
}
# ä»… 550 tokensï¼

# ç¬¬2æ­¥ï¼šAIæŒ‰éœ€è¯·æ±‚æ•°æ®
if AIåˆ¤æ–­éœ€è¦ä¸Šä¸‹æ–‡:
    AIè°ƒç”¨å·¥å…·: get_recent_checkins(days=7)
    ç³»ç»Ÿè¿”å›: æœ€è¿‘7å¤©çš„check-inæ•°æ® (1000 tokens)
else:
    ä¸åŠ è½½ï¼Œç›´æ¥å›å¤

# ç»“æœï¼šå¹³å‡æ¯æ¬¡è¯·æ±‚ä»… 1500-2000 tokens
# èŠ‚çœç‡ï¼š84%
```

**å®ç°æŠ€æœ¯**ï¼š

- Claude APIçš„Tool UseåŠŸèƒ½
- å·¥å…·å®šä¹‰ï¼š`get_recent_checkins`, `get_assessment_history`, `get_risk_events`
- æŒ‰éœ€è°ƒç”¨ï¼šAIæ™ºèƒ½å†³å®šä½•æ—¶éœ€è¦å“ªäº›æ•°æ®

**æ•ˆæœå¯¹æ¯”**ï¼š

| æŒ‡æ ‡         | ä¼ ç»Ÿæ–¹æ³• | JIT Context | æ”¹è¿›     |
| ------------ | -------- | ----------- | -------- |
| å¹³å‡Tokenæ•°  | 10,000   | 1,600       | **-84%** |
| APIæˆæœ¬/è¯·æ±‚ | $0.30    | $0.048      | **-84%** |
| å“åº”æ—¶é—´     | 3-5ç§’    | 1-2ç§’       | **-60%** |

#### åˆ›æ–°2ï¼šæ··åˆé£é™©æ£€æµ‹

**æŠ€æœ¯æ¶æ„**ï¼š

```
ç”¨æˆ·æ¶ˆæ¯è¾“å…¥
    â†“
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬1å±‚ï¼šè§„åˆ™å¼•æ“         â”‚  â† å¿«é€Ÿï¼ˆ<10msï¼‰
â”‚ - å…³é”®è¯åŒ¹é…            â”‚
â”‚ - æ­£åˆ™è¡¨è¾¾å¼            â”‚
â”‚ - è¯­è¨€æ£€æµ‹              â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
   æ˜¯å¦è§¦å‘é«˜é£é™©ï¼Ÿ
    â”œâ”€ å¦ â†’ è¿”å›ç»“æœï¼ˆä½/ä¸­é£é™©æˆ–æ— é£é™©ï¼‰
    â”‚
    â””â”€ æ˜¯ â†“
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬2å±‚ï¼šLLMéªŒè¯          â”‚  â† ç²¾ç¡®ï¼ˆ1-2ç§’ï¼‰
â”‚ - Claude APIåˆ†æ        â”‚
â”‚ - ä¸Šä¸‹æ–‡ç†è§£            â”‚
â”‚ - è¯¯æŠ¥è¿‡æ»¤              â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
  åˆå¹¶ç»“æœ
    â†“
  è¿”å›æœ€ç»ˆé£é™©è¯„ä¼°
```

**ä¼˜åŠ¿**ï¼š

- **é€Ÿåº¦**ï¼š90%çš„æ¶ˆæ¯åªéœ€è§„åˆ™å¼•æ“ï¼ˆæ¯«ç§’çº§ï¼‰
- **å‡†ç¡®**ï¼šé«˜é£é™©æ¶ˆæ¯LLMäºŒæ¬¡éªŒè¯ï¼ˆé™ä½è¯¯æŠ¥ï¼‰
- **æˆæœ¬**ï¼šä»…10%æ¶ˆæ¯è°ƒç”¨LLM API

#### åˆ›æ–°3ï¼šæ”¿æ²»åˆ›ä¼¤ç‰¹å®šæ¨¡å¼è¯†åˆ«

**æŠ€æœ¯å®ç°**ï¼š

```python
# ä¸“é—¨çš„æç¤ºè¯æ¨¡æ¿
POLITICAL_TRAUMA_PROMPT = """
ä½ æ˜¯ä¸“é—¨ä¸ºæ”¿æ²»åˆ›ä¼¤å¹¸å­˜è€…è®¾è®¡çš„AIåŠ©æ‰‹ã€‚
ç‰¹åˆ«æ³¨æ„ä»¥ä¸‹ç‰¹å®šæ¨¡å¼ï¼š

1. æµäº¡ç»æœ›ï¼ˆExile Despairï¼‰ï¼š
   - å…³é”®è¯ï¼šæ— æ³•å›å®¶ã€ç¥–å›½ã€æ°¸è¿œçš„æµäº¡
   - æƒ…ç»ªï¼šæ— æœ›ã€å¤±æ ¹ã€èº«ä»½å±æœº

2. å¹¸å­˜è€…å†…ç–šï¼ˆSurvivor's Guiltï¼‰ï¼š
   - å…³é”®è¯ï¼šä¸ºä»€ä¹ˆæ˜¯æˆ‘æ´»ä¸‹æ¥ã€æˆ‘ä¸é…ã€åŒä¼´
   - æƒ…ç»ªï¼šæ„§ç–šã€è‡ªè´£ã€ä¸å…¬å¹³æ„Ÿ

3. è¿«å®³ææƒ§ï¼ˆPersecution Fearï¼‰ï¼š
   - å…³é”®è¯ï¼šè¢«ç›‘è§†ã€ä¸å®‰å…¨ã€ä»–ä»¬ä¼šæ‰¾åˆ°æˆ‘
   - æƒ…ç»ªï¼šææƒ§ã€paranoiaã€è¿‡åº¦è­¦è§‰

4. æ–‡åŒ–é”™ä½ï¼ˆCultural Displacementï¼‰ï¼š
   - å…³é”®è¯ï¼šä¸å±äºè¿™é‡Œã€è¯­è¨€éšœç¢ã€å­¤ç‹¬
   - æƒ…ç»ªï¼šç–ç¦»ã€ä¸é€‚åº”ã€èº«ä»½æ··ä¹±
"""

# å¤šè¯­è¨€æ£€æµ‹è§„åˆ™
EXILE_KEYWORDS = {
    "zh": ["æ— æ³•å›å®¶", "æµäº¡", "å†ä¹Ÿå›ä¸å»", "å¤±å»ç¥–å›½"],
    "en": ["can't go home", "exile", "lost my country"],
    "fa": ["ØªØ¨Ø¹ÛŒØ¯", "ÙˆØ·Ù†", "Ø¨Ø§Ø²Ú¯Ø´Øª"],  # æ³¢æ–¯è¯­
    "tr": ["sÃ¼rgÃ¼n", "vatan", "dÃ¶nÃ¼ÅŸ"],  # åœŸè€³å…¶è¯­
    "es": ["exilio", "patria", "regreso"]  # è¥¿ç­ç‰™è¯­
}
```

---

## ğŸ“Š æ•°æ®æ¨¡å‹è®¾è®¡

### æ ¸å¿ƒè¡¨ç»“æ„ï¼ˆ20å¼ è¡¨ï¼‰

#### ç”¨æˆ·ä¸è§’è‰²è¡¨

**usersï¼ˆç”¨æˆ·è¡¨ï¼‰**

```sql
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) UNIQUE NOT NULL,
    hashed_password VARCHAR(255) NOT NULL,
    role VARCHAR(20) NOT NULL,  -- PATIENT, DOCTOR, ADMIN
    is_active BOOLEAN DEFAULT TRUE,
    email_verified BOOLEAN DEFAULT FALSE,
    must_change_password BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

**patientsï¼ˆæ‚£è€…è¡¨ï¼‰**

```sql
CREATE TABLE patients (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID UNIQUE REFERENCES users(id) ON DELETE CASCADE,
    primary_doctor_id UUID REFERENCES doctors(id),

    -- åŸºæœ¬ä¿¡æ¯
    full_name VARCHAR(255),
    date_of_birth DATE,
    gender VARCHAR(20),
    phone VARCHAR(50),

    -- åŒ»ç–—ä¿¡æ¯
    emergency_contact JSONB,
    medical_history TEXT,
    current_medications TEXT,
    allergies TEXT,

    -- å¿ƒç†èƒŒæ™¯
    psychological_background TEXT,
    trauma_description TEXT,
    previous_therapy BOOLEAN,

    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

**doctorsï¼ˆåŒ»ç”Ÿè¡¨ï¼‰**

```sql
CREATE TABLE doctors (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID UNIQUE REFERENCES users(id) ON DELETE CASCADE,

    -- åŸºæœ¬ä¿¡æ¯
    full_name VARCHAR(255) NOT NULL,
    phone VARCHAR(50),

    -- ä¸“ä¸šä¿¡æ¯
    specialty VARCHAR(255),
    license_number VARCHAR(100),
    education TEXT,
    experience_years INTEGER,

    -- è¯Šæ‰€ä¿¡æ¯
    clinic_name VARCHAR(255),
    clinic_address TEXT,

    bio TEXT,

    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

#### å¯¹è¯ä¸AIäº¤äº’è¡¨

**conversationsï¼ˆæ‚£è€…AIå¯¹è¯ï¼‰**

```sql
CREATE TABLE conversations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    patient_id UUID NOT NULL REFERENCES patients(id) ON DELETE CASCADE,

    type VARCHAR(50) DEFAULT 'emotional_support',  -- emotional_support, pre_visit
    status VARCHAR(20) DEFAULT 'active',  -- active, ended

    messages JSONB NOT NULL DEFAULT '[]',  -- æ¶ˆæ¯æ•°ç»„
    summary TEXT,  -- AIç”Ÿæˆçš„æ‘˜è¦

    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    ended_at TIMESTAMP
);

-- messages JSONB ç»“æ„ç¤ºä¾‹ï¼š
-- [
--   {
--     "role": "user",
--     "content": "æˆ‘ä»Šå¤©æ„Ÿè§‰å¾ˆç³Ÿç³•",
--     "timestamp": "2024-01-15T10:30:00Z"
--   },
--   {
--     "role": "assistant",
--     "content": "æˆ‘å¾ˆé—æ†¾å¬åˆ°ä½ æ„Ÿè§‰ä¸å¥½...",
--     "timestamp": "2024-01-15T10:30:05Z"
--   }
-- ]
```

**doctor_conversationsï¼ˆåŒ»ç”ŸAIå¯¹è¯ï¼‰**

```sql
CREATE TABLE doctor_conversations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    doctor_id UUID NOT NULL REFERENCES doctors(id) ON DELETE CASCADE,
    patient_id UUID NOT NULL REFERENCES patients(id) ON DELETE CASCADE,

    messages JSONB NOT NULL DEFAULT '[]',
    summary TEXT,

    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

#### å¥åº·æ•°æ®è¡¨

**daily_checkinsï¼ˆæ¯æ—¥ç­¾åˆ°ï¼‰**

```sql
CREATE TABLE daily_checkins (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    patient_id UUID NOT NULL REFERENCES patients(id) ON DELETE CASCADE,

    checkin_date DATE NOT NULL,
    mood_score INTEGER NOT NULL CHECK (mood_score >= 0 AND mood_score <= 10),
    sleep_hours FLOAT,
    sleep_quality VARCHAR(20),  -- very_poor, poor, fair, good, excellent
    took_medication BOOLEAN,
    notes TEXT,

    created_at TIMESTAMP DEFAULT NOW(),

    UNIQUE (patient_id, checkin_date)
);

-- æ€§èƒ½ä¼˜åŒ–ç´¢å¼•
CREATE INDEX ix_checkins_patient_date
ON daily_checkins(patient_id, checkin_date DESC);
```

**assessmentsï¼ˆå¿ƒç†è¯„ä¼°ï¼‰**

```sql
CREATE TABLE assessments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    patient_id UUID NOT NULL REFERENCES patients(id) ON DELETE CASCADE,

    assessment_type VARCHAR(20) NOT NULL,  -- PHQ9, GAD7, PSS, ISI, PCL5
    responses JSONB NOT NULL,  -- é—®å·ç­”æ¡ˆ
    total_score INTEGER NOT NULL,
    severity_level VARCHAR(50),  -- æ ¹æ®é‡è¡¨çš„ä¸¥é‡ç¨‹åº¦åˆ†çº§

    created_at TIMESTAMP DEFAULT NOW()
);

-- ç´¢å¼•ä¼˜åŒ–
CREATE INDEX ix_assessments_patient_created
ON assessments(patient_id, created_at DESC);

CREATE INDEX ix_assessments_type
ON assessments(assessment_type);
```

#### é£é™©ç®¡ç†è¡¨

**risk_eventsï¼ˆé£é™©äº‹ä»¶ï¼‰**

```sql
CREATE TABLE risk_events (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    patient_id UUID NOT NULL REFERENCES patients(id) ON DELETE CASCADE,
    conversation_id UUID REFERENCES conversations(id),

    risk_level VARCHAR(20) NOT NULL,  -- CRITICAL, HIGH, MEDIUM, LOW
    risk_type VARCHAR(50),  -- SUICIDAL, SELF_HARM, VIOLENCE, PERSECUTION_FEAR, OTHER

    trigger_text TEXT NOT NULL,  -- è§¦å‘é£é™©çš„æ¶ˆæ¯å†…å®¹
    ai_confidence FLOAT,  -- 0.0-1.0, AIæ£€æµ‹ç½®ä¿¡åº¦
    detected_patterns JSONB,  -- æ£€æµ‹åˆ°çš„å…·ä½“æ¨¡å¼

    doctor_reviewed BOOLEAN DEFAULT FALSE,
    reviewed_by UUID REFERENCES doctors(id),
    reviewed_at TIMESTAMP,
    doctor_notes TEXT,

    created_at TIMESTAMP DEFAULT NOW()
);

-- å…³é”®ç´¢å¼•ï¼šåŒ»ç”Ÿé£é™©é˜Ÿåˆ—æŸ¥è¯¢ä¼˜åŒ–
CREATE INDEX ix_risks_unreviewed
ON risk_events(doctor_reviewed, created_at DESC);

CREATE INDEX ix_risks_patient_created
ON risk_events(patient_id, created_at DESC);
```

#### æ¶ˆæ¯ä¸é€šä¿¡è¡¨

**doctor_patient_threadsï¼ˆæ¶ˆæ¯çº¿ç¨‹ï¼‰**

```sql
CREATE TABLE doctor_patient_threads (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    doctor_id UUID NOT NULL REFERENCES doctors(id) ON DELETE CASCADE,
    patient_id UUID NOT NULL REFERENCES patients(id) ON DELETE CASCADE,

    last_message_at TIMESTAMP,
    unread_count_doctor INTEGER DEFAULT 0,
    unread_count_patient INTEGER DEFAULT 0,

    created_at TIMESTAMP DEFAULT NOW(),

    UNIQUE (doctor_id, patient_id)
);

CREATE INDEX ix_threads_last_message
ON doctor_patient_threads(last_message_at DESC);
```

**direct_messagesï¼ˆç›´æ¥æ¶ˆæ¯ï¼‰**

```sql
CREATE TABLE direct_messages (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    thread_id UUID NOT NULL REFERENCES doctor_patient_threads(id) ON DELETE CASCADE,
    sender_id UUID NOT NULL REFERENCES users(id),

    content TEXT NOT NULL,
    message_type VARCHAR(20) DEFAULT 'text',  -- text, image, file

    is_read BOOLEAN DEFAULT FALSE,
    read_at TIMESTAMP,

    created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX ix_messages_thread_created
ON direct_messages(thread_id, created_at DESC);

CREATE INDEX ix_messages_thread_unread
ON direct_messages(thread_id, is_read);
```

**message_attachmentsï¼ˆæ¶ˆæ¯é™„ä»¶ï¼‰**

```sql
CREATE TABLE message_attachments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    message_id UUID NOT NULL REFERENCES direct_messages(id) ON DELETE CASCADE,

    file_name VARCHAR(255) NOT NULL,
    file_size INTEGER NOT NULL,  -- bytes
    file_type VARCHAR(100),  -- MIME type
    storage_url TEXT NOT NULL,  -- S3/MinIO URL

    created_at TIMESTAMP DEFAULT NOW()
);
```

#### é¢„çº¦ä¸æŠ¥å‘Šè¡¨

**appointmentsï¼ˆé¢„çº¦ï¼‰**

```sql
CREATE TABLE appointments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    doctor_id UUID NOT NULL REFERENCES doctors(id) ON DELETE CASCADE,
    patient_id UUID NOT NULL REFERENCES patients(id) ON DELETE CASCADE,

    scheduled_at TIMESTAMP NOT NULL,
    duration_minutes INTEGER DEFAULT 30,
    appointment_type VARCHAR(50),  -- initial, followup, emergency
    status VARCHAR(20) DEFAULT 'pending',  -- pending, confirmed, completed, cancelled

    patient_notes TEXT,
    doctor_notes TEXT,
    completion_notes TEXT,

    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    completed_at TIMESTAMP,
    cancelled_at TIMESTAMP
);

CREATE INDEX ix_appointments_doctor_scheduled
ON appointments(doctor_id, scheduled_at);

CREATE INDEX ix_appointments_patient_scheduled
ON appointments(patient_id, scheduled_at);
```

**pre_visit_summariesï¼ˆå°±è¯Šå‰æ‘˜è¦ï¼‰**

```sql
CREATE TABLE pre_visit_summaries (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    patient_id UUID NOT NULL REFERENCES patients(id) ON DELETE CASCADE,
    doctor_id UUID NOT NULL REFERENCES doctors(id),
    appointment_id UUID REFERENCES appointments(id),

    summary_data JSONB NOT NULL,  -- ç»“æ„åŒ–æ‘˜è¦æ•°æ®
    ai_recommendations TEXT,

    created_at TIMESTAMP DEFAULT NOW()
);
```

**generated_reportsï¼ˆç”Ÿæˆçš„æŠ¥å‘Šï¼‰**

```sql
CREATE TABLE generated_reports (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    report_type VARCHAR(50) NOT NULL,  -- pre_visit_summary, data_export
    related_id UUID,  -- å…³è”çš„è®°å½•ID

    file_name VARCHAR(255) NOT NULL,
    file_url TEXT NOT NULL,
    file_size INTEGER,

    generated_by UUID REFERENCES users(id),
    created_at TIMESTAMP DEFAULT NOW(),
    expires_at TIMESTAMP  -- ä¸´æ—¶æ–‡ä»¶è¿‡æœŸæ—¶é—´
);
```

#### æ•°æ®å¯¼å‡ºä¸åˆè§„è¡¨

**data_exportsï¼ˆæ•°æ®å¯¼å‡ºè¯·æ±‚ï¼‰**

```sql
CREATE TABLE data_exports (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,

    export_format VARCHAR(20) NOT NULL,  -- json, csv, pdf
    include_options JSONB NOT NULL,  -- åŒ…å«å“ªäº›æ•°æ®çš„é€‰é¡¹

    status VARCHAR(20) DEFAULT 'pending',  -- pending, processing, completed, failed
    file_url TEXT,
    download_token VARCHAR(255) UNIQUE,

    requested_at TIMESTAMP DEFAULT NOW(),
    completed_at TIMESTAMP,
    expires_at TIMESTAMP,  -- ä¸‹è½½é“¾æ¥è¿‡æœŸæ—¶é—´
    downloaded_at TIMESTAMP
);

-- é˜²æ­¢é¢‘ç¹å¯¼å‡º
CREATE INDEX ix_exports_user_requested
ON data_exports(user_id, requested_at DESC);
```

#### è¿æ¥ä¸è®¤è¯è¡¨

**connection_requestsï¼ˆè¿æ¥è¯·æ±‚ï¼‰**

```sql
CREATE TABLE connection_requests (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    doctor_id UUID NOT NULL REFERENCES doctors(id) ON DELETE CASCADE,
    patient_id UUID NOT NULL REFERENCES patients(id) ON DELETE CASCADE,

    status VARCHAR(20) DEFAULT 'pending',  -- pending, accepted, rejected, cancelled
    message TEXT,

    created_at TIMESTAMP DEFAULT NOW(),
    responded_at TIMESTAMP
);
```

**password_reset_tokensï¼ˆå¯†ç é‡ç½®ä»¤ç‰Œï¼‰**

```sql
CREATE TABLE password_reset_tokens (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,

    token VARCHAR(255) UNIQUE NOT NULL,
    expires_at TIMESTAMP NOT NULL,
    used BOOLEAN DEFAULT FALSE,

    created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX ix_password_reset_token
ON password_reset_tokens(token);
```

**email_queueï¼ˆé‚®ä»¶é˜Ÿåˆ—ï¼‰**

```sql
CREATE TABLE email_queue (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    recipient VARCHAR(255) NOT NULL,
    subject VARCHAR(500) NOT NULL,
    html_body TEXT NOT NULL,
    text_body TEXT,

    email_type VARCHAR(50),  -- risk_alert, password_reset, invitation
    status VARCHAR(20) DEFAULT 'pending',  -- pending, sent, failed

    retry_count INTEGER DEFAULT 0,
    max_retries INTEGER DEFAULT 3,
    last_error TEXT,

    created_at TIMESTAMP DEFAULT NOW(),
    sent_at TIMESTAMP
);

CREATE INDEX ix_email_queue_status
ON email_queue(status, created_at);
```

#### å®¡è®¡ä¸ç¬”è®°è¡¨

**clinical_notesï¼ˆä¸´åºŠç¬”è®°ï¼‰**

```sql
CREATE TABLE clinical_notes (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    doctor_id UUID NOT NULL REFERENCES doctors(id) ON DELETE CASCADE,
    patient_id UUID NOT NULL REFERENCES patients(id) ON DELETE CASCADE,

    note_type VARCHAR(50),  -- progress_note, assessment, treatment_plan
    content TEXT NOT NULL,

    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

**audit_logsï¼ˆå®¡è®¡æ—¥å¿—ï¼‰**

```sql
CREATE TABLE audit_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id),

    action VARCHAR(100) NOT NULL,  -- login, create_patient, view_data, etc.
    resource_type VARCHAR(50),
    resource_id UUID,

    details JSONB,
    ip_address VARCHAR(50),
    user_agent TEXT,

    created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX ix_audit_logs_user_created
ON audit_logs(user_id, created_at DESC);

CREATE INDEX ix_audit_logs_action
ON audit_logs(action, created_at DESC);
```

---

### æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

#### ç´¢å¼•ç­–ç•¥æ€»ç»“

```sql
-- 1. é«˜é¢‘æŸ¥è¯¢è·¯å¾„ä¼˜åŒ–
CREATE INDEX ix_checkins_patient_date ON daily_checkins(patient_id, checkin_date DESC);
CREATE INDEX ix_assessments_patient_created ON assessments(patient_id, created_at DESC);
CREATE INDEX ix_risks_unreviewed ON risk_events(doctor_reviewed, created_at DESC);

-- 2. æ¶ˆæ¯ç³»ç»Ÿä¼˜åŒ–
CREATE INDEX ix_messages_thread_unread ON direct_messages(thread_id, is_read);
CREATE INDEX ix_threads_last_message ON doctor_patient_threads(last_message_at DESC);

-- 3. åŒ»ç”Ÿå·¥ä½œæµä¼˜åŒ–
CREATE INDEX ix_patients_doctor ON patients(primary_doctor_id);
CREATE INDEX ix_appointments_doctor_scheduled ON appointments(doctor_id, scheduled_at);

-- 4. å®‰å…¨ä¸åˆè§„ä¼˜åŒ–
CREATE INDEX ix_audit_logs_user_created ON audit_logs(user_id, created_at DESC);
CREATE INDEX ix_exports_user_requested ON data_exports(user_id, requested_at DESC);
```

#### æŸ¥è¯¢ä¼˜åŒ–æŠ€å·§

1. **ä½¿ç”¨EXPLAIN ANALYZE**åˆ†ææŸ¥è¯¢è®¡åˆ’

```sql
EXPLAIN ANALYZE
SELECT * FROM daily_checkins
WHERE patient_id = 'xxx' AND checkin_date >= CURRENT_DATE - 30
ORDER BY checkin_date DESC;
```

2. **é¿å…N+1æŸ¥è¯¢**

```python
# âŒ åçš„åšæ³•ï¼ˆN+1æŸ¥è¯¢ï¼‰
patients = await db.execute(select(Patient).limit(20))
for patient in patients.scalars():
    doctor = await db.get(Doctor, patient.primary_doctor_id)  # æ¯æ¬¡æŸ¥è¯¢

# âœ… å¥½çš„åšæ³•ï¼ˆeager loadingï¼‰
result = await db.execute(
    select(Patient)
    .options(selectinload(Patient.primary_doctor))
    .limit(20)
)
patients = result.scalars().all()
```

3. **æ‰¹é‡æ“ä½œ**

```python
# âŒ åçš„åšæ³•
for checkin_data in checkin_list:
    checkin = DailyCheckin(**checkin_data)
    db.add(checkin)
    await db.commit()  # æ¯æ¬¡éƒ½æäº¤

# âœ… å¥½çš„åšæ³•
checkins = [DailyCheckin(**data) for data in checkin_list]
db.add_all(checkins)
await db.commit()  # ä¸€æ¬¡æ€§æäº¤
```

4. **é™åˆ¶JSONBæŸ¥è¯¢**

```sql
-- å°½é‡ä½¿ç”¨ç´¢å¼•åˆ—è¿‡æ»¤ï¼Œè€ŒéJSONBå†…å®¹
-- âŒ æ…¢
SELECT * FROM conversations WHERE messages::text LIKE '%suicide%';

-- âœ… å¿«
SELECT * FROM conversations c
JOIN risk_events r ON r.conversation_id = c.id
WHERE r.risk_type = 'SUICIDAL';
```

---

## ğŸ”’ å®‰å…¨æ¶æ„è®¾è®¡

### è®¤è¯ä¸æˆæƒ

#### è®¤è¯æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ç”¨æˆ·è®¤è¯æµç¨‹                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ­¥éª¤1ï¼šç”¨æˆ·ç™»å½•
  â”œâ”€â”€ è¾“å…¥ï¼šemail + password
  â”œâ”€â”€ åç«¯éªŒè¯ï¼š
  â”‚   â”œâ”€â”€ æŸ¥è¯¢usersè¡¨
  â”‚   â”œâ”€â”€ bcryptéªŒè¯å¯†ç ï¼ˆ12è½®åŠ å¯†ï¼‰
  â”‚   â””â”€â”€ æ£€æŸ¥is_activeçŠ¶æ€
  â””â”€â”€ éªŒè¯æˆåŠŸ â†’ æ­¥éª¤2

æ­¥éª¤2ï¼šç”ŸæˆJWTä»¤ç‰Œ
  â”œâ”€â”€ PayloadåŒ…å«ï¼š
  â”‚   â”œâ”€â”€ user_id (UUID)
  â”‚   â”œâ”€â”€ email
  â”‚   â”œâ”€â”€ role (PATIENT/DOCTOR/ADMIN)
  â”‚   â”œâ”€â”€ iat (ç­¾å‘æ—¶é—´)
  â”‚   â””â”€â”€ exp (è¿‡æœŸæ—¶é—´ï¼š24å°æ—¶)
  â”œâ”€â”€ ç­¾åï¼šHS256 + SECRET_KEY
  â””â”€â”€ è¿”å›ç»™å®¢æˆ·ç«¯

æ­¥éª¤3ï¼šå®¢æˆ·ç«¯å­˜å‚¨
  â”œâ”€â”€ localStorage: token
  â””â”€â”€ æ¯æ¬¡è¯·æ±‚æºå¸¦ï¼šAuthorization: Bearer <token>

æ­¥éª¤4ï¼šä»¤ç‰ŒéªŒè¯ï¼ˆä¸­é—´ä»¶ï¼‰
  â”œâ”€â”€ è§£æAuthorization header
  â”œâ”€â”€ éªŒè¯ç­¾å
  â”œâ”€â”€ æ£€æŸ¥è¿‡æœŸæ—¶é—´
  â”œâ”€â”€ æ£€æŸ¥Redisé»‘åå•ï¼ˆæ˜¯å¦å·²æ’¤é”€ï¼‰
  â””â”€â”€ éªŒè¯æˆåŠŸ â†’ æå–userä¿¡æ¯ â†’ ç»§ç»­è¯·æ±‚

æ­¥éª¤5ï¼šç™»å‡º
  â”œâ”€â”€ å°†tokenåŠ å…¥Redisé»‘åå•
  â”œâ”€â”€ TTL = å‰©ä½™æœ‰æ•ˆæœŸ
  â””â”€â”€ å®¢æˆ·ç«¯æ¸…é™¤localStorage
```

#### å¯†ç å®‰å…¨

```python
from passlib.context import CryptContext

pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")

# å¯†ç å“ˆå¸Œï¼ˆæ³¨å†Œæ—¶ï¼‰
hashed_password = pwd_context.hash("user_password")
# ç»“æœï¼š$2b$12$KIXXvZ... (60å­—ç¬¦)

# å¯†ç éªŒè¯ï¼ˆç™»å½•æ—¶ï¼‰
is_valid = pwd_context.verify("user_password", hashed_password)
```

**å®‰å…¨å‚æ•°**ï¼š

- ç®—æ³•ï¼šbcrypt
- è½®æ•°ï¼š12ï¼ˆ2^12 = 4096æ¬¡è¿­ä»£ï¼‰
- ç›ï¼šè‡ªåŠ¨éšæœºç”Ÿæˆ

#### åŒå› ç´ è®¤è¯ï¼ˆMFAï¼‰

```python
import pyotp

# ç”ŸæˆTOTPå¯†é’¥
secret = pyotp.random_base32()
totp = pyotp.TOTP(secret)

# ç”ŸæˆäºŒç»´ç URI
qr_uri = totp.provisioning_uri(
    name=user.email,
    issuer_name="HeartGuardian AI"
)

# éªŒè¯TOTP code
is_valid = totp.verify(user_input_code)
```

**MFAæµç¨‹**ï¼š

1. ç”¨æˆ·å¯ç”¨MFA
2. ç³»ç»Ÿç”ŸæˆTOTPå¯†é’¥
3. ç”¨æˆ·æ‰«æäºŒç»´ç ï¼ˆGoogle Authenticatorç­‰ï¼‰
4. ç™»å½•æ—¶é™¤äº†å¯†ç ï¼Œè¿˜éœ€è¾“å…¥6ä½åŠ¨æ€ç 
5. æœåŠ¡å™¨éªŒè¯åŠ¨æ€ç ï¼ˆ30ç§’æ—¶é—´çª—å£ï¼‰

---

### æˆæƒä¸è®¿é—®æ§åˆ¶

#### è§’è‰²æƒé™çŸ©é˜µ

| èµ„æº             | æ‚£è€…ï¼ˆPATIENTï¼‰ | åŒ»ç”Ÿï¼ˆDOCTORï¼‰  | ç®¡ç†å‘˜ï¼ˆADMINï¼‰ |
| ---------------- | --------------- | --------------- | --------------- |
| **è‡ªå·±çš„èµ„æ–™**   | âœ… è¯»å†™         | âœ… è¯»å†™         | âœ… å…¨éƒ¨         |
| **AIå¯¹è¯**       | âœ… è‡ªå·±çš„       | âœ… å·²è¿æ¥æ‚£è€…çš„ | âœ… å…¨éƒ¨         |
| **Check-inæ•°æ®** | âœ… è‡ªå·±çš„       | âœ… å·²è¿æ¥æ‚£è€…çš„ | âœ… å…¨éƒ¨         |
| **å¿ƒç†è¯„ä¼°**     | âœ… è‡ªå·±çš„       | âœ… å·²è¿æ¥æ‚£è€…çš„ | âœ… å…¨éƒ¨         |
| **é£é™©äº‹ä»¶**     | âŒ              | âœ… å·²è¿æ¥æ‚£è€…çš„ | âœ… å…¨éƒ¨         |
| **æ‚£è€…åˆ—è¡¨**     | âŒ              | âœ… è‡ªå·±çš„æ‚£è€…   | âœ… å…¨éƒ¨         |
| **åˆ›å»ºæ‚£è€…è´¦æˆ·** | âŒ              | âœ…              | âœ…              |
| **æ¶ˆæ¯ç³»ç»Ÿ**     | âœ… ä¸åŒ»ç”Ÿ       | âœ… ä¸æ‚£è€…       | âœ… å…¨éƒ¨         |
| **é¢„çº¦ç®¡ç†**     | âœ… è‡ªå·±çš„       | âœ… è‡ªå·±åˆ›å»ºçš„   | âœ… å…¨éƒ¨         |
| **å®¡è®¡æ—¥å¿—**     | âŒ              | âŒ              | âœ…              |

#### æƒé™æ£€æŸ¥å®ç°

```python
from fastapi import Depends, HTTPException, status
from app.utils.deps import get_current_user

# ä¾èµ–æ³¨å…¥ï¼šè·å–å½“å‰ç”¨æˆ·
async def get_current_user(token: str = Depends(oauth2_scheme)) -> User:
    # éªŒè¯JWTï¼Œè¿”å›Userå¯¹è±¡
    ...

# è§’è‰²æ£€æŸ¥è£…é¥°å™¨
async def require_role(required_role: str, current_user: User = Depends(get_current_user)):
    if current_user.role != required_role:
        raise HTTPException(status_code=403, detail="Permission denied")
    return current_user

# ä½¿ç”¨ç¤ºä¾‹
@router.get("/doctor/patients")
async def get_patients(
    current_doctor: User = Depends(lambda u: require_role("DOCTOR", u))
):
    # ä»…åŒ»ç”Ÿå¯è®¿é—®
    ...

# æ‚£è€…-åŒ»ç”Ÿè¿æ¥æ£€æŸ¥
async def check_patient_access(
    patient_id: UUID,
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db)
):
    if current_user.role == "PATIENT":
        # æ‚£è€…åªèƒ½è®¿é—®è‡ªå·±çš„æ•°æ®
        if str(current_user.id) != str(patient_id):
            raise HTTPException(status_code=403)
    elif current_user.role == "DOCTOR":
        # åŒ»ç”Ÿåªèƒ½è®¿é—®å·²è¿æ¥æ‚£è€…çš„æ•°æ®
        patient = await db.get(Patient, patient_id)
        if patient.primary_doctor_id != current_user.doctor.id:
            raise HTTPException(status_code=403)
    # ADMINå¯è®¿é—®æ‰€æœ‰
    return patient_id
```

---

### æ•°æ®å®‰å…¨

#### ä¼ è¾“åŠ å¯†

- **HTTPS/TLS 1.3**ï¼šæ‰€æœ‰APIé€šä¿¡å¼ºåˆ¶HTTPS
- **WebSocket over TLS**ï¼šwss://åè®®
- **Certificate Pinning**ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰ï¼šé˜²æ­¢ä¸­é—´äººæ”»å‡»

#### æ•°æ®åŠ å¯†

```python
# æ•æ„Ÿå­—æ®µåŠ å¯†ï¼ˆå¯é€‰ï¼‰
from cryptography.fernet import Fernet

# ç”ŸæˆåŠ å¯†å¯†é’¥
key = Fernet.generate_key()
cipher = Fernet(key)

# åŠ å¯†
encrypted_data = cipher.encrypt(b"sensitive data")

# è§£å¯†
decrypted_data = cipher.decrypt(encrypted_data)
```

**åŠ å¯†ç­–ç•¥**ï¼š

- æ•°æ®åº“ï¼šPostgreSQLå¯ç”¨TDEï¼ˆTransparent Data Encryptionï¼‰
- å¤‡ä»½ï¼šåŠ å¯†å¤‡ä»½æ–‡ä»¶
- å¯¹è±¡å­˜å‚¨ï¼šS3æœåŠ¡å™¨ç«¯åŠ å¯†ï¼ˆSSE-S3ï¼‰

#### è¾“å…¥éªŒè¯ä¸å‡€åŒ–

```python
from pydantic import BaseModel, EmailStr, validator, Field

class UserRegister(BaseModel):
    email: EmailStr  # è‡ªåŠ¨éªŒè¯é‚®ç®±æ ¼å¼
    password: str = Field(..., min_length=8, max_length=100)
    full_name: str = Field(..., min_length=1, max_length=255)

    @validator('password')
    def password_strength(cls, v):
        # å¯†ç å¼ºåº¦æ£€æŸ¥
        if not any(c.isupper() for c in v):
            raise ValueError('å¯†ç å¿…é¡»åŒ…å«å¤§å†™å­—æ¯')
        if not any(c.isdigit() for c in v):
            raise ValueError('å¯†ç å¿…é¡»åŒ…å«æ•°å­—')
        return v

    @validator('full_name')
    def sanitize_name(cls, v):
        # é˜²æ­¢XSSï¼šç§»é™¤HTMLæ ‡ç­¾
        import re
        return re.sub(r'<[^>]+>', '', v)
```

**é˜²æŠ¤æªæ–½**ï¼š

- **SQLæ³¨å…¥**ï¼šSQLAlchemyå‚æ•°åŒ–æŸ¥è¯¢
- **XSS**ï¼šè¾“å‡ºHTMLç¼–ç 
- **CSRF**ï¼šSameSite Cookie + CSRF Token
- **è·¯å¾„éå†**ï¼šæ–‡ä»¶è·¯å¾„ç™½åå•éªŒè¯

---

### é€Ÿç‡é™åˆ¶

```python
from fastapi import Request
from slowapi import Limiter
from slowapi.util import get_remote_address

limiter = Limiter(key_func=get_remote_address)

# åº”ç”¨é€Ÿç‡é™åˆ¶
@router.post("/auth/login")
@limiter.limit("5/minute")  # æ¯åˆ†é’Ÿæœ€å¤š5æ¬¡
async def login(request: Request, credentials: LoginRequest):
    ...

# åŠ¨æ€é€Ÿç‡é™åˆ¶
@router.post("/chat/stream")
@limiter.limit("20/hour")  # AIå¯¹è¯é™åˆ¶
async def chat_stream(request: Request, message: ChatMessage):
    ...
```

**é€Ÿç‡é™åˆ¶ç­–ç•¥**ï¼š

| ç«¯ç‚¹ç±»å‹ | é€Ÿç‡é™åˆ¶   | ç†ç”±       |
| -------- | ---------- | ---------- |
| ç™»å½•     | 5æ¬¡/åˆ†é’Ÿ   | é˜²æš´åŠ›ç ´è§£ |
| æ³¨å†Œ     | 3æ¬¡/å°æ—¶   | é˜²æ‰¹é‡æ³¨å†Œ |
| AIå¯¹è¯   | 20æ¬¡/å°æ—¶  | é˜²æ»¥ç”¨API  |
| æ•°æ®å¯¼å‡º | 1æ¬¡/24å°æ—¶ | GDPRåˆè§„   |
| å¯†ç é‡ç½® | 3æ¬¡/å°æ—¶   | é˜²æšä¸¾æ”»å‡» |
| ä¸€èˆ¬API  | 100æ¬¡/åˆ†é’Ÿ | é˜²DDoS     |

---

### GDPRä¸éšç§åˆè§„

#### æ•°æ®ä¸»ä½“æƒåˆ©

| æƒåˆ©             | å®ç°                                |
| ---------------- | ----------------------------------- |
| **è®¿é—®æƒ**       | APIæŸ¥çœ‹æ‰€æœ‰ä¸ªäººæ•°æ®                 |
| **å¯¼å‡ºæƒ**       | JSON/CSV/PDFæ ¼å¼å¯¼å‡º                |
| **åˆ é™¤æƒ**       | è´¦æˆ·åˆ é™¤åŠŸèƒ½ï¼ˆCASCADEåˆ é™¤å…³è”æ•°æ®ï¼‰ |
| **æ›´æ­£æƒ**       | ä¸ªäººèµ„æ–™ç¼–è¾‘API                     |
| **é™åˆ¶å¤„ç†æƒ**   | è´¦æˆ·åœç”¨åŠŸèƒ½                        |
| **æ•°æ®å¯æºå¸¦æƒ** | ç»“æ„åŒ–æ•°æ®å¯¼å‡º                      |

#### æ•°æ®å¤„ç†é€æ˜åº¦

```markdown
éšç§æ”¿ç­–å…³é”®ç‚¹ï¼š

1. æ”¶é›†çš„æ•°æ®ï¼šå¯¹è¯å†…å®¹ã€å¥åº·æ•°æ®ã€è¯„ä¼°ç»“æœ
2. ä½¿ç”¨ç›®çš„ï¼šæä¾›å¿ƒç†å¥åº·æ”¯æŒã€é£é™©é¢„è­¦ã€åŒ»æ‚£åä½œ
3. æ•°æ®å…±äº«ï¼šä»…ä¸æ‚¨æˆæƒçš„åŒ»ç”Ÿå…±äº«
4. æ•°æ®å­˜å‚¨ï¼šåŠ å¯†å­˜å‚¨äºAWS/é˜¿é‡Œäº‘
5. ä¿ç•™æœŸé™ï¼šè´¦æˆ·æ´»è·ƒæœŸé—´ + åˆ é™¤å7å¤©
6. AIå¤„ç†ï¼šä½¿ç”¨Anthropic Claude APIï¼ˆç¬¦åˆGDPRï¼‰
7. è”ç³»æ–¹å¼ï¼šprivacy@heartguardian.com
```

#### æ•°æ®ä¿ç•™æ”¿ç­–

```python
# è‡ªåŠ¨æ•°æ®æ¸…ç†ä»»åŠ¡
async def cleanup_expired_data():
    # 1. åˆ é™¤è¿‡æœŸçš„å¯†ç é‡ç½®ä»¤ç‰Œ
    await db.execute(
        delete(PasswordResetToken)
        .where(PasswordResetToken.expires_at < datetime.utcnow())
    )

    # 2. åˆ é™¤è¿‡æœŸçš„æ•°æ®å¯¼å‡ºæ–‡ä»¶
    await db.execute(
        delete(DataExport)
        .where(DataExport.expires_at < datetime.utcnow())
    )

    # 3. åˆ é™¤å·²åˆ é™¤ç”¨æˆ·çš„æ•°æ®ï¼ˆ7å¤©å®½é™æœŸï¼‰
    await db.execute(
        delete(User)
        .where(
            User.is_active == False,
            User.deleted_at < datetime.utcnow() - timedelta(days=7)
        )
    )
```

---

### å®¡è®¡ä¸ç›‘æ§

#### å®¡è®¡æ—¥å¿—

```python
# è‡ªåŠ¨è®°å½•å®¡è®¡æ—¥å¿—
async def log_audit(
    user_id: UUID,
    action: str,
    resource_type: str = None,
    resource_id: UUID = None,
    details: dict = None,
    request: Request = None
):
    audit_log = AuditLog(
        user_id=user_id,
        action=action,
        resource_type=resource_type,
        resource_id=resource_id,
        details=details,
        ip_address=request.client.host if request else None,
        user_agent=request.headers.get("user-agent") if request else None
    )
    db.add(audit_log)
    await db.commit()

# å…³é”®æ“ä½œè‡ªåŠ¨å®¡è®¡
AUDITED_ACTIONS = [
    "user_login",
    "user_logout",
    "view_patient_data",
    "create_patient",
    "delete_patient",
    "export_data",
    "change_password",
    "risk_event_created",
    "connection_accepted"
]
```

#### å®‰å…¨ç›‘æ§å‘Šè­¦

```python
# å¼‚å¸¸è¡Œä¸ºæ£€æµ‹
async def detect_anomalies():
    # 1. æ£€æµ‹çŸ­æ—¶é—´å†…å¤šæ¬¡å¤±è´¥ç™»å½•
    failed_logins = await db.execute(
        select(AuditLog)
        .where(
            AuditLog.action == "login_failed",
            AuditLog.created_at > datetime.utcnow() - timedelta(minutes=5)
        )
        .group_by(AuditLog.ip_address)
        .having(func.count() > 5)
    )

    # 2. æ£€æµ‹å¼‚å¸¸æ•°æ®è®¿é—®
    unusual_access = await db.execute(
        select(AuditLog)
        .where(
            AuditLog.action == "view_patient_data",
            AuditLog.created_at > datetime.utcnow() - timedelta(hours=1)
        )
        .group_by(AuditLog.user_id)
        .having(func.count() > 100)  # 1å°æ—¶è®¿é—®è¶…è¿‡100ä¸ªæ‚£è€…
    )

    # 3. å‘é€å‘Šè­¦
    if failed_logins or unusual_access:
        await send_security_alert(admin_email, "Suspicious activity detected")
```

---

## ğŸ“ˆ æ€§èƒ½è®¾è®¡ä¸ä¼˜åŒ–

### æ€§èƒ½ç›®æ ‡ï¼ˆSLAï¼‰

| æŒ‡æ ‡                     | ç›®æ ‡å€¼    | ä¸´ç•Œå€¼   | æµ‹é‡æ–¹æ³•           |
| ------------------------ | --------- | -------- | ------------------ |
| **APIå“åº”æ—¶é—´ï¼ˆP50ï¼‰**   | < 200ms   | < 500ms  | Prometheus metrics |
| **APIå“åº”æ—¶é—´ï¼ˆP95ï¼‰**   | < 500ms   | < 1000ms | Prometheus metrics |
| **APIå“åº”æ—¶é—´ï¼ˆP99ï¼‰**   | < 1000ms  | < 2000ms | Prometheus metrics |
| **AIå¯¹è¯å“åº”ï¼ˆé¦–å­—èŠ‚ï¼‰** | < 2ç§’     | < 5ç§’    | å®¢æˆ·ç«¯è®¡æ—¶         |
| **é”™è¯¯ç‡**               | < 0.1%    | < 1%     | Error logs         |
| **ååé‡**               | > 100 RPS | > 50 RPS | Load testing       |
| **æ•°æ®åº“è¿æ¥æ± åˆ©ç”¨ç‡**   | < 70%     | < 90%    | PgBouncer stats    |
| **å†…å­˜ä½¿ç”¨ç‡**           | < 70%     | < 85%    | Container metrics  |

### åç«¯æ€§èƒ½ä¼˜åŒ–

#### æ•°æ®åº“ä¼˜åŒ–

**1. è¿æ¥æ± é…ç½®**

```python
# app/database.py
from sqlalchemy.ext.asyncio import create_async_engine, AsyncSession
from sqlalchemy.orm import sessionmaker

engine = create_async_engine(
    DATABASE_URL,
    pool_size=20,          # å¸¸é©»è¿æ¥æ•°
    max_overflow=10,       # æœ€å¤§æº¢å‡ºè¿æ¥æ•°
    pool_timeout=30,       # è·å–è¿æ¥è¶…æ—¶ï¼ˆç§’ï¼‰
    pool_recycle=3600,     # è¿æ¥å›æ”¶æ—¶é—´ï¼ˆç§’ï¼‰
    pool_pre_ping=True,    # è¿æ¥å‰pingæ£€æµ‹
    echo=False             # ç”Ÿäº§ç¯å¢ƒå…³é—­SQLæ—¥å¿—
)
```

**2. æŸ¥è¯¢ä¼˜åŒ–ç¤ºä¾‹**

```python
# âŒ ä½æ•ˆæŸ¥è¯¢
async def get_patient_dashboard_data_slow(patient_id: UUID):
    patient = await db.get(Patient, patient_id)
    checkins = await db.execute(
        select(DailyCheckin)
        .where(DailyCheckin.patient_id == patient_id)
        .order_by(DailyCheckin.checkin_date.desc())
        .limit(30)
    )
    assessments = await db.execute(
        select(Assessment)
        .where(Assessment.patient_id == patient_id)
        .order_by(Assessment.created_at.desc())
    )
    # 3æ¬¡æ•°æ®åº“æŸ¥è¯¢

# âœ… ä¼˜åŒ–åï¼ˆå¹¶å‘æŸ¥è¯¢ï¼‰
async def get_patient_dashboard_data_fast(patient_id: UUID):
    patient_task = db.get(Patient, patient_id)
    checkins_task = db.execute(
        select(DailyCheckin)
        .where(DailyCheckin.patient_id == patient_id)
        .order_by(DailyCheckin.checkin_date.desc())
        .limit(30)
    )
    assessments_task = db.execute(
        select(Assessment)
        .where(Assessment.patient_id == patient_id)
        .order_by(Assessment.created_at.desc())
        .limit(5)
    )

    # å¹¶å‘æ‰§è¡Œ
    patient, checkins_result, assessments_result = await asyncio.gather(
        patient_task, checkins_task, assessments_task
    )
    # 1æ¬¡å¾€è¿”ï¼ˆå¹¶å‘ï¼‰
```

**3. ç¼“å­˜ç­–ç•¥**

```python
import redis.asyncio as redis
from functools import wraps

redis_client = redis.from_url("redis://localhost:6379")

def cached(ttl: int = 300):
    """ç¼“å­˜è£…é¥°å™¨"""
    def decorator(func):
        @wraps(func)
        async def wrapper(*args, **kwargs):
            # ç”Ÿæˆç¼“å­˜key
            cache_key = f"{func.__name__}:{args}:{kwargs}"

            # å°è¯•ä»ç¼“å­˜è·å–
            cached_value = await redis_client.get(cache_key)
            if cached_value:
                return json.loads(cached_value)

            # ç¼“å­˜æœªå‘½ä¸­ï¼Œæ‰§è¡Œå‡½æ•°
            result = await func(*args, **kwargs)

            # å†™å…¥ç¼“å­˜
            await redis_client.setex(
                cache_key,
                ttl,
                json.dumps(result, default=str)
            )
            return result
        return wrapper
    return decorator

# ä½¿ç”¨ç¤ºä¾‹
@cached(ttl=300)  # ç¼“å­˜5åˆ†é’Ÿ
async def get_patient_list(doctor_id: UUID):
    result = await db.execute(
        select(Patient)
        .where(Patient.primary_doctor_id == doctor_id)
    )
    return result.scalars().all()
```

#### APIä¼˜åŒ–

**1. å“åº”å‹ç¼©**

```python
from fastapi.middleware.gzip import GZipMiddleware

app.add_middleware(GZIPMiddleware, minimum_size=1000)  # è¶…è¿‡1KBå‹ç¼©
```

**2. åˆ†é¡µä¼˜åŒ–**

```python
from typing import Generic, TypeVar, List
from pydantic import BaseModel

T = TypeVar('T')

class PaginatedResponse(BaseModel, Generic[T]):
    items: List[T]
    total: int
    page: int
    page_size: int
    has_next: bool
    has_prev: bool

async def paginate(
    query: Select,
    page: int = 1,
    page_size: int = 20
) -> PaginatedResponse:
    # è®¡ç®—æ€»æ•°ï¼ˆä¼˜åŒ–ï¼šä½¿ç”¨count(*)è€Œécount(id)ï¼‰
    count_query = select(func.count()).select_from(query.alias())
    total = await db.scalar(count_query)

    # è·å–åˆ†é¡µæ•°æ®
    offset = (page - 1) * page_size
    items_result = await db.execute(
        query.limit(page_size).offset(offset)
    )
    items = items_result.scalars().all()

    return PaginatedResponse(
        items=items,
        total=total,
        page=page,
        page_size=page_size,
        has_next=offset + page_size < total,
        has_prev=page > 1
    )
```

**3. æ‰¹é‡æ“ä½œä¼˜åŒ–**

```python
# âŒ å¾ªç¯å•ä¸ªæ’å…¥
for data in check_in_data_list:
    checkin = DailyCheckin(**data)
    db.add(checkin)
    await db.commit()  # æ¯æ¬¡éƒ½æäº¤ï¼Œæ…¢ï¼

# âœ… æ‰¹é‡æ’å…¥
from sqlalchemy.dialects.postgresql import insert

stmt = insert(DailyCheckin).values(check_in_data_list)
await db.execute(stmt)
await db.commit()  # ä¸€æ¬¡æ€§æäº¤
```

### å‰ç«¯æ€§èƒ½ä¼˜åŒ–

#### ä»£ç åˆ†å‰²ä¸æ‡’åŠ è½½

```tsx
// app/(patient)/chat/page.tsx
import dynamic from 'next/dynamic'
import { Suspense } from 'react'

// åŠ¨æ€å¯¼å…¥ï¼ˆä»£ç åˆ†å‰²ï¼‰
const ChatInterface = dynamic(() => import('@/components/chat/ChatInterface'), {
  loading: () => <LoadingSpinner />,
  ssr: false, // ä»…å®¢æˆ·ç«¯æ¸²æŸ“
})

export default function ChatPage() {
  return (
    <Suspense fallback={<LoadingSpinner />}>
      <ChatInterface />
    </Suspense>
  )
}
```

#### å›¾ç‰‡ä¼˜åŒ–

```tsx
import Image from 'next/image'

;<Image
  src="/patient-avatar.jpg"
  alt="Patient Avatar"
  width={80}
  height={80}
  loading="lazy" // æ‡’åŠ è½½
  quality={75} // è´¨é‡75%
  placeholder="blur" // æ¨¡ç³Šå ä½ç¬¦
/>
```

#### APIè¯·æ±‚ä¼˜åŒ–

```tsx
import { useQuery } from '@tanstack/react-query'

// React Queryç¼“å­˜
function usePatientData(patientId: string) {
  return useQuery({
    queryKey: ['patient', patientId],
    queryFn: () => api.getPatient(patientId),
    staleTime: 5 * 60 * 1000, // 5åˆ†é’Ÿå†…è®¤ä¸ºæ•°æ®æ–°é²œ
    cacheTime: 10 * 60 * 1000, // 10åˆ†é’Ÿç¼“å­˜
    refetchOnWindowFocus: false, // çª—å£èšç„¦æ—¶ä¸é‡æ–°è·å–
  })
}
```

#### è™šæ‹Ÿæ»šåŠ¨ï¼ˆé•¿åˆ—è¡¨ä¼˜åŒ–ï¼‰

```tsx
import { VirtualList } from '@/components/ui/virtual-list'

function MessageList({ messages }: { messages: Message[] }) {
  return (
    <VirtualList
      data={messages}
      itemHeight={80}
      height={600}
      renderItem={(message) => <MessageItem message={message} />}
    />
  )
}
```

### AIå¼•æ“ä¼˜åŒ–

#### Tokenä½¿ç”¨ä¼˜åŒ–

**é—®é¢˜**ï¼šä¼ ç»Ÿæ–¹æ³•æ¯æ¬¡è¯·æ±‚æ¶ˆè€—å¤§é‡token
**è§£å†³æ–¹æ¡ˆ**ï¼šå³æ—¶ä¸Šä¸‹æ–‡åŠ è½½ï¼ˆå‰æ–‡å·²è¯¦è¿°ï¼‰

**æ•ˆæœ**ï¼š

- å¹³å‡tokenæ¶ˆè€—ï¼š10,000 â†’ 1,600ï¼ˆ-84%ï¼‰
- APIæˆæœ¬ï¼š$0.30 â†’ $0.048ï¼ˆ-84%ï¼‰
- å“åº”é€Ÿåº¦ï¼š3-5ç§’ â†’ 1-2ç§’ï¼ˆ-60%ï¼‰

#### æµå¼å“åº”ä¼˜åŒ–

```python
# ä½¿ç”¨SSEï¼ˆServer-Sent Eventsï¼‰æµå¼ä¼ è¾“
async def stream_chat_response(message: str, patient_id: UUID):
    async def event_generator():
        async with anthropic.messages.stream(
            model="claude-3-sonnet-20240229",
            messages=[{"role": "user", "content": message}],
            max_tokens=1024
        ) as stream:
            async for text in stream.text_stream:
                yield f"data: {json.dumps({'content': text})}\n\n"

        yield "data: [DONE]\n\n"

    return StreamingResponse(
        event_generator(),
        media_type="text/event-stream"
    )
```

**å¥½å¤„**ï¼š

- ç”¨æˆ·ç«‹å³çœ‹åˆ°è¾“å‡ºï¼ˆé™ä½æ„ŸçŸ¥å»¶è¿Ÿï¼‰
- å¯æå‰ç»ˆæ­¢ï¼ˆèŠ‚çœæˆæœ¬ï¼‰
- æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ

### ç›‘æ§ä¸æ€§èƒ½æµ‹è¯•

#### æ€§èƒ½ç›‘æ§ä»£ç 

```python
# app/utils/metrics.py
import time
from functools import wraps
from typing import Dict, List
from collections import defaultdict

class MetricsCollector:
    def __init__(self):
        self.metrics: Dict[str, List[float]] = defaultdict(list)

    def record(self, operation: str, duration: float):
        self.metrics[operation].append(duration)

    def get_stats(self, operation: str):
        durations = self.metrics[operation]
        if not durations:
            return None

        sorted_durations = sorted(durations)
        count = len(sorted_durations)

        return {
            "count": count,
            "min": min(sorted_durations),
            "max": max(sorted_durations),
            "mean": sum(sorted_durations) / count,
            "p50": sorted_durations[int(count * 0.5)],
            "p95": sorted_durations[int(count * 0.95)],
            "p99": sorted_durations[int(count * 0.99)]
        }

metrics_collector = MetricsCollector()

def timed(operation: str):
    """æ€§èƒ½è®¡æ—¶è£…é¥°å™¨"""
    def decorator(func):
        @wraps(func)
        async def wrapper(*args, **kwargs):
            start = time.time()
            try:
                result = await func(*args, **kwargs)
                return result
            finally:
                duration = time.time() - start
                metrics_collector.record(operation, duration)
        return wrapper
    return decorator

# ä½¿ç”¨ç¤ºä¾‹
@timed("get_patient_list")
async def get_patient_list(doctor_id: UUID):
    ...
```

#### è´Ÿè½½æµ‹è¯•ï¼ˆLocustï¼‰

```python
# tests/load/locustfile.py
from locust import HttpUser, task, between

class HeartGuardianUser(HttpUser):
    wait_time = between(1, 3)  # ç”¨æˆ·æ“ä½œé—´éš”1-3ç§’

    def on_start(self):
        # ç™»å½•
        response = self.client.post("/api/v1/auth/login", json={
            "email": "test@example.com",
            "password": "password123"
        })
        self.token = response.json()["access_token"]
        self.client.headers.update({"Authorization": f"Bearer {self.token}"})

    @task(3)  # æƒé‡3ï¼šæœ€å¸¸ç”¨çš„æ“ä½œ
    def view_dashboard(self):
        self.client.get("/api/v1/clinical/checkins?limit=30")

    @task(2)  # æƒé‡2
    def send_chat_message(self):
        self.client.post("/api/v1/chat/stream", json={
            "message": "I'm feeling anxious today"
        })

    @task(1)  # æƒé‡1
    def submit_checkin(self):
        self.client.post("/api/v1/clinical/checkin", json={
            "mood_score": 5,
            "sleep_hours": 7.5,
            "sleep_quality": "fair",
            "took_medication": True
        })
```

**è¿è¡Œè´Ÿè½½æµ‹è¯•**ï¼š

```bash
# æ¨¡æ‹Ÿ50ä¸ªå¹¶å‘ç”¨æˆ·ï¼Œæ¯ç§’å¢åŠ 5ä¸ªï¼ŒæŒç»­5åˆ†é’Ÿ
locust -f tests/load/locustfile.py \
  --host=http://localhost:8000 \
  --headless \
  -u 50 \
  -r 5 \
  -t 5m \
  --csv=results/load_test
```

---

## ğŸŒ å›½é™…åŒ–ä¸å¯è®¿é—®æ€§

### å¤šè¯­è¨€æ”¯æŒ

#### æ”¯æŒçš„è¯­è¨€

| è¯­è¨€           | ä»£ç  | è¦†ç›–èŒƒå›´ |
| -------------- | ---- | -------- |
| ä¸­æ–‡ï¼ˆç®€ä½“ï¼‰   | zh   | å®Œæ•´     |
| è‹±è¯­           | en   | å®Œæ•´     |
| è¥¿ç­ç‰™è¯­       | es   | å®Œæ•´     |
| é˜¿æ‹‰ä¼¯è¯­       | ar   | å®Œæ•´     |
| æ³¢æ–¯è¯­         | fa   | å®Œæ•´     |
| åœŸè€³å…¶è¯­       | tr   | å®Œæ•´     |
| æ³•è¯­           | fr   | UIå±‚     |
| å¾·è¯­           | de   | UIå±‚     |
| ä¿„è¯­           | ru   | UIå±‚     |
| è‘¡è„ç‰™è¯­       | pt   | UIå±‚     |
| æµ·åœ°å…‹é‡Œå¥¥å°”è¯­ | ht   | UIå±‚     |
| è¶Šå—è¯­         | vi   | UIå±‚     |

#### å®ç°æ–¹å¼

```tsx
// frontend/src/i18n/config.ts
import { getRequestConfig } from 'next-intl/server'

export default getRequestConfig(async ({ locale }) => ({
  messages: (await import(`./locales/${locale}.json`)).default,
}))
```

```json
// frontend/src/i18n/locales/zh.json
{
  "common": {
    "appName": "å¿ƒå®ˆAI",
    "tagline": "ä¸“ä¸ºæ”¿æ²»åˆ›ä¼¤å¹¸å­˜è€…è®¾è®¡çš„AIå¿ƒç†å¥åº·å¹³å°",
    "submit": "æäº¤",
    "cancel": "å–æ¶ˆ"
  },
  "chat": {
    "placeholder": "åœ¨è¿™é‡Œè¾“å…¥æ‚¨çš„æ¶ˆæ¯...",
    "send": "å‘é€",
    "thinking": "AIæ­£åœ¨æ€è€ƒ..."
  },
  "assessment": {
    "phq9": {
      "title": "PHQ-9 æŠ‘éƒç—‡ç­›æŸ¥",
      "question1": "åšäº‹æ—¶æä¸èµ·åŠ²æˆ–æ²¡æœ‰å…´è¶£",
      ...
    }
  }
}
```

#### AIå¯¹è¯å¤šè¯­è¨€

```python
# è‡ªåŠ¨æ£€æµ‹ç”¨æˆ·è¯­è¨€å¹¶å“åº”
async def detect_language(text: str) -> str:
    # ç®€å•çš„è¯­è¨€æ£€æµ‹ï¼ˆå¯ç”¨langdetectåº“ï¼‰
    chinese_chars = len(re.findall(r'[\u4e00-\u9fff]', text))
    arabic_chars = len(re.findall(r'[\u0600-\u06ff]', text))

    if chinese_chars > 5:
        return "zh"
    elif arabic_chars > 5:
        return "ar"
    else:
        return "en"

# ç³»ç»Ÿæç¤ºè¯æ ¹æ®è¯­è¨€è°ƒæ•´
SYSTEM_PROMPTS = {
    "zh": "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å¿ƒç†å¥åº·AIåŠ©æ‰‹ï¼Œä¸“é—¨ä¸ºæ”¿æ²»åˆ›ä¼¤å¹¸å­˜è€…æä¾›æ”¯æŒ...",
    "en": "You are a professional mental health AI assistant specialized in supporting political trauma survivors...",
    "ar": "Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù…ØªØ®ØµØµ ÙÙŠ Ø§Ù„ØµØ­Ø© Ø§Ù„Ù†ÙØ³ÙŠØ©...",
}

async def chat_with_language_support(message: str, patient_id: UUID):
    lang = await detect_language(message)
    system_prompt = SYSTEM_PROMPTS.get(lang, SYSTEM_PROMPTS["en"])

    response = await anthropic.messages.create(
        model="claude-3-sonnet-20240229",
        system=system_prompt,
        messages=[{"role": "user", "content": message}]
    )
    return response
```

### PWAï¼ˆæ¸è¿›å¼Webåº”ç”¨ï¼‰

#### ç¦»çº¿æ”¯æŒ

```javascript
// frontend/public/sw.js (Service Worker)
const CACHE_NAME = 'heartguardian-v1'
const OFFLINE_URLS = ['/', '/login', '/dashboard', '/offline.html']

self.addEventListener('install', (event) => {
  event.waitUntil(
    caches.open(CACHE_NAME).then((cache) => {
      return cache.addAll(OFFLINE_URLS)
    })
  )
})

self.addEventListener('fetch', (event) => {
  event.respondWith(
    caches.match(event.request).then((response) => {
      return (
        response ||
        fetch(event.request).catch(() => {
          return caches.match('/offline.html')
        })
      )
    })
  )
})
```

#### Manifesté…ç½®

```json
// frontend/public/manifest.json
{
  "name": "Heart Guardian AI",
  "short_name": "HeartGuard",
  "description": "AI-powered mental health support for political trauma survivors",
  "start_url": "/",
  "display": "standalone",
  "background_color": "#ffffff",
  "theme_color": "#3b82f6",
  "icons": [
    {
      "src": "/icons/icon-192x192.png",
      "sizes": "192x192",
      "type": "image/png",
      "purpose": "any maskable"
    },
    {
      "src": "/icons/icon-512x512.png",
      "sizes": "512x512",
      "type": "image/png",
      "purpose": "any maskable"
    }
  ],
  "categories": ["health", "medical", "lifestyle"],
  "lang": "en-US",
  "dir": "ltr",
  "orientation": "portrait-primary"
}
```

### æ— éšœç¢è®¾è®¡ï¼ˆAccessibilityï¼‰

#### WCAG 2.1 AAçº§åˆè§„

```tsx
// ä½¿ç”¨Radix UIç¡®ä¿æ— éšœç¢
import * as Dialog from '@radix-ui/react-dialog'

function AccessibleModal() {
  return (
    <Dialog.Root>
      <Dialog.Trigger asChild>
        <button aria-label="æ‰“å¼€è®¾ç½®">è®¾ç½®</button>
      </Dialog.Trigger>

      <Dialog.Portal>
        <Dialog.Overlay className="DialogOverlay" />
        <Dialog.Content className="DialogContent" aria-describedby="dialog-description">
          <Dialog.Title>è®¾ç½®</Dialog.Title>
          <Dialog.Description id="dialog-description">åœ¨è¿™é‡Œè°ƒæ•´æ‚¨çš„åå¥½è®¾ç½®</Dialog.Description>

          {/* å†…å®¹ */}

          <Dialog.Close asChild>
            <button aria-label="å…³é—­">Ã—</button>
          </Dialog.Close>
        </Dialog.Content>
      </Dialog.Portal>
    </Dialog.Root>
  )
}
```

#### é”®ç›˜å¯¼èˆª

```tsx
// ç¡®ä¿æ‰€æœ‰äº¤äº’å…ƒç´ å¯é”®ç›˜è®¿é—®
function ChatInput() {
  const handleKeyDown = (e: React.KeyboardEvent) => {
    // Ctrl/Cmd + Enter å‘é€æ¶ˆæ¯
    if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
      sendMessage()
    }
    // Escape æ¸…ç©ºè¾“å…¥
    if (e.key === 'Escape') {
      clearInput()
    }
  }

  return (
    <textarea
      aria-label="è¾“å…¥æ¶ˆæ¯"
      placeholder="è¾“å…¥æ‚¨çš„æ¶ˆæ¯..."
      onKeyDown={handleKeyDown}
      tabIndex={0}
    />
  )
}
```

#### é¢œè‰²å¯¹æ¯”åº¦

```css
/* ç¡®ä¿æ–‡æœ¬å¯¹æ¯”åº¦è‡³å°‘4.5:1 */
:root {
  --text-primary: #1a1a1a; /* å¯¹ç™½è‰²èƒŒæ™¯ 21:1 */
  --text-secondary: #666666; /* å¯¹ç™½è‰²èƒŒæ™¯ 5.74:1 */
  --bg-primary: #ffffff;
  --bg-secondary: #f5f5f5;

  /* æ·±è‰²æ¨¡å¼ */
  --dark-text-primary: #ffffff;
  --dark-text-secondary: #b3b3b3;
  --dark-bg-primary: #1a1a1a;
  --dark-bg-secondary: #2d2d2d;
}
```

---

## ğŸš€ éƒ¨ç½²æ¶æ„

### å¼€å‘ç¯å¢ƒ

```yaml
# docker-compose.yml
version: '3.8'

services:
  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: heartguardian
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - '5432:5432'
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    ports:
      - '6379:6379'
    volumes:
      - redis_data:/data

  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    ports:
      - '9000:9000'
      - '9001:9001'
    volumes:
      - minio_data:/data

volumes:
  postgres_data:
  redis_data:
  minio_data:
```

**å¯åŠ¨**ï¼š

```bash
docker-compose up -d
cd backend && uvicorn app.main:app --reload --port 8000
cd frontend && npm run dev
```

### ç”Ÿäº§ç¯å¢ƒ

#### æ¶æ„é€‰æ‹©

**æ–¹æ¡ˆAï¼šå•æœåŠ¡å™¨éƒ¨ç½²ï¼ˆå°è§„æ¨¡ï¼‰**

```
é€‚ç”¨åœºæ™¯ï¼š< 100å¹¶å‘ç”¨æˆ·
é…ç½®ï¼š4æ ¸CPU + 8GBå†…å­˜ + 100GB SSD
æˆæœ¬ï¼šçº¦$50/æœˆ

â”œâ”€â”€ Nginxï¼ˆåå‘ä»£ç† + SSLç»ˆæ­¢ï¼‰
â”œâ”€â”€ Uvicornï¼ˆFastAPIï¼Œ4 workersï¼‰
â”œâ”€â”€ PostgreSQLï¼ˆæœ¬åœ°ï¼‰
â”œâ”€â”€ Redisï¼ˆæœ¬åœ°ï¼‰
â””â”€â”€ MinIOï¼ˆæœ¬åœ°ï¼‰
```

**æ–¹æ¡ˆBï¼šäº‘æœåŠ¡éƒ¨ç½²ï¼ˆæ¨èï¼‰**

```
é€‚ç”¨åœºæ™¯ï¼š100-5000å¹¶å‘ç”¨æˆ·
æˆæœ¬ï¼šçº¦$200-500/æœˆ

AWSæ¶æ„ï¼š
â”œâ”€â”€ CloudFrontï¼ˆCDNï¼‰
â”œâ”€â”€ ALBï¼ˆè´Ÿè½½å‡è¡¡ï¼‰
â”œâ”€â”€ ECS Fargateï¼ˆæ— æœåŠ¡å™¨å®¹å™¨ï¼Œè‡ªåŠ¨æ‰©å±•ï¼‰
â”‚   â””â”€â”€ FastAPI + Next.jså®¹å™¨
â”œâ”€â”€ RDS PostgreSQLï¼ˆMulti-AZï¼Œä¸»ä»å¤åˆ¶ï¼‰
â”œâ”€â”€ ElastiCache Redisï¼ˆé›†ç¾¤æ¨¡å¼ï¼‰
â”œâ”€â”€ S3ï¼ˆå¯¹è±¡å­˜å‚¨ï¼‰
â”œâ”€â”€ SESï¼ˆé‚®ä»¶å‘é€ï¼‰
â””â”€â”€ CloudWatchï¼ˆç›‘æ§å‘Šè­¦ï¼‰

é˜¿é‡Œäº‘æ¶æ„ï¼š
â”œâ”€â”€ CDN
â”œâ”€â”€ SLBï¼ˆè´Ÿè½½å‡è¡¡ï¼‰
â”œâ”€â”€ ECS + ACKï¼ˆå®¹å™¨æœåŠ¡ï¼‰
â”œâ”€â”€ RDS PostgreSQL
â”œâ”€â”€ Redisä¼ä¸šç‰ˆ
â”œâ”€â”€ OSSï¼ˆå¯¹è±¡å­˜å‚¨ï¼‰
â””â”€â”€ äº‘ç›‘æ§
```

#### Dockerç”Ÿäº§éƒ¨ç½²

```dockerfile
# backend/Dockerfile
FROM python:3.11-slim

WORKDIR /app

# å®‰è£…ä¾èµ–
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# å¤åˆ¶ä»£ç 
COPY . .

# érootç”¨æˆ·è¿è¡Œ
RUN useradd -m appuser && chown -R appuser:appuser /app
USER appuser

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=3s \
  CMD curl -f http://localhost:8000/health || exit 1

# å¯åŠ¨
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000", "--workers", "4"]
```

```dockerfile
# frontend/Dockerfile
FROM node:20-alpine AS builder

WORKDIR /app
COPY package*.json ./
RUN npm ci

COPY . .
RUN npm run build

# ç”Ÿäº§é•œåƒ
FROM node:20-alpine

WORKDIR /app
COPY --from=builder /app/.next ./.next
COPY --from=builder /app/public ./public
COPY --from=builder /app/package*.json ./
RUN npm ci --only=production

USER node
CMD ["npm", "start"]
```

#### Kuberneteséƒ¨ç½²ï¼ˆå¤§è§„æ¨¡ï¼‰

```yaml
# k8s/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: heartguardian-backend
spec:
  replicas: 3
  selector:
    matchLabels:
      app: heartguardian-backend
  template:
    metadata:
      labels:
        app: heartguardian-backend
    spec:
      containers:
        - name: backend
          image: heartguardian/backend:latest
          ports:
            - containerPort: 8000
          env:
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: db-credentials
                  key: url
            - name: ANTHROPIC_API_KEY
              valueFrom:
                secretKeyRef:
                  name: api-keys
                  key: anthropic
          resources:
            requests:
              memory: '512Mi'
              cpu: '500m'
            limits:
              memory: '1Gi'
              cpu: '1000m'
          livenessProbe:
            httpGet:
              path: /health
              port: 8000
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /health
              port: 8000
            initialDelaySeconds: 5
            periodSeconds: 5

---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: heartguardian-backend-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: heartguardian-backend
  minReplicas: 3
  maxReplicas: 10
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80
```

### CI/CDæµç¨‹

```yaml
# .github/workflows/deploy.yml
name: Deploy to Production

on:
  push:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run tests
        run: |
          cd backend
          pip install -r requirements-dev.txt
          pytest --cov=app tests/

      - name: Security scan
        run: |
          pip install bandit safety
          bandit -r backend/app
          safety check

  build-and-deploy:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push Docker image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t $ECR_REGISTRY/heartguardian-backend:$IMAGE_TAG backend/
          docker push $ECR_REGISTRY/heartguardian-backend:$IMAGE_TAG

      - name: Deploy to ECS
        run: |
          aws ecs update-service \
            --cluster heartguardian-cluster \
            --service heartguardian-backend \
            --force-new-deployment
```

---

## ğŸ“Š ç›‘æ§ä¸å¯è§‚æµ‹æ€§

### ç›‘æ§æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                åº”ç”¨å±‚                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ Backend  â”‚  â”‚ Frontend â”‚  â”‚ Database â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜      â”‚
â”‚       â”‚             â”‚             â”‚             â”‚
â”‚       â”œâ”€ Logs â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤             â”‚
â”‚       â”œâ”€ Metrics â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤             â”‚
â”‚       â””â”€ Traces â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              æ”¶é›†å±‚                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  Loki    â”‚  â”‚Prometheusâ”‚  â”‚  Jaeger  â”‚      â”‚
â”‚  â”‚  (Logs)  â”‚  â”‚(Metrics) â”‚  â”‚ (Traces) â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚             â”‚             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              å¯è§†åŒ–å±‚                            â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚         â”‚      Grafana        â”‚                 â”‚
â”‚         â”‚  ç»Ÿä¸€ä»ªè¡¨æ¿          â”‚                 â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å…³é”®æŒ‡æ ‡

#### åº”ç”¨æŒ‡æ ‡

```python
# app/middleware/metrics.py
from prometheus_client import Counter, Histogram, Gauge
import time

# è¯·æ±‚è®¡æ•°å™¨
request_count = Counter(
    'http_requests_total',
    'Total HTTP requests',
    ['method', 'endpoint', 'status']
)

# è¯·æ±‚å»¶è¿Ÿ
request_latency = Histogram(
    'http_request_duration_seconds',
    'HTTP request latency',
    ['method', 'endpoint']
)

# æ´»è·ƒè¿æ¥æ•°
active_connections = Gauge(
    'websocket_connections_active',
    'Number of active WebSocket connections'
)

# é£é™©äº‹ä»¶
risk_events_created = Counter(
    'risk_events_total',
    'Total risk events created',
    ['level', 'type']
)

# ä¸­é—´ä»¶
@app.middleware("http")
async def metrics_middleware(request: Request, call_next):
    method = request.method
    endpoint = request.url.path

    start_time = time.time()

    response = await call_next(request)

    duration = time.time() - start_time
    status = response.status_code

    request_count.labels(method=method, endpoint=endpoint, status=status).inc()
    request_latency.labels(method=method, endpoint=endpoint).observe(duration)

    return response
```

#### Grafanaä»ªè¡¨æ¿é…ç½®

```json
{
  "dashboard": {
    "title": "Heart Guardian AI - System Overview",
    "panels": [
      {
        "title": "Request Rate",
        "targets": [
          {
            "expr": "rate(http_requests_total[5m])"
          }
        ]
      },
      {
        "title": "P95 Latency",
        "targets": [
          {
            "expr": "histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))"
          }
        ]
      },
      {
        "title": "Error Rate",
        "targets": [
          {
            "expr": "rate(http_requests_total{status=~\"5..\"}[5m]) / rate(http_requests_total[5m])"
          }
        ]
      },
      {
        "title": "Risk Events by Level",
        "targets": [
          {
            "expr": "sum(risk_events_total) by (level)"
          }
        ]
      },
      {
        "title": "Database Connection Pool",
        "targets": [
          {
            "expr": "db_pool_connections_used / db_pool_connections_max"
          }
        ]
      }
    ]
  }
}
```

### å‘Šè­¦è§„åˆ™

```yaml
# prometheus/alerts.yml
groups:
  - name: critical
    interval: 30s
    rules:
      - alert: HighErrorRate
        expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.01
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: 'High error rate detected'
          description: 'Error rate is {{ $value | humanizePercentage }}'

      - alert: HighLatency
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: 'High API latency'
          description: 'P95 latency is {{ $value }}s'

      - alert: DatabaseDown
        expr: up{job="postgres"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: 'Database is down'

      - alert: CriticalRiskEventUnreviewed
        expr: risk_events_unreviewed{level="CRITICAL"} > 0
        for: 15m
        labels:
          severity: warning
        annotations:
          summary: 'Critical risk event not reviewed'
          description: '{{ $value }} critical risk events pending review'
```

---

## ğŸ¯ äº§å“å·®å¼‚åŒ–ä¼˜åŠ¿æ€»ç»“

### ä¸ç«å“å¯¹æ¯”

| ç‰¹æ€§                 | Heart Guardian AI | BetterHelp      | Talkspace       | Woebot       |
| -------------------- | ----------------- | --------------- | --------------- | ------------ |
| **AIæ”¯æŒ**           | âœ… 24/7 Claude AI | âŒ              | âŒ              | âœ… åŸºç¡€AI    |
| **äººå·¥åŒ»ç”Ÿ**         | âœ… å®Œæ•´åä½œ       | âœ…              | âœ…              | âŒ           |
| **æ”¿æ²»åˆ›ä¼¤ä¸“é¡¹**     | âœ… ä¸“é—¨ä¼˜åŒ–       | âŒ              | âŒ              | âŒ           |
| **å¤šè¯­è¨€é£é™©æ£€æµ‹**   | âœ… 5è¯­è¨€          | âŒ              | âŒ              | âŒ           |
| **å®æ—¶é£é™©é¢„è­¦**     | âœ… 4çº§åˆ†ç±»        | âŒ              | âŒ              | âœ… ç®€å•      |
| **æ•°æ®å¯¼å‡ºï¼ˆGDPRï¼‰** | âœ… 3æ ¼å¼          | âš ï¸ æœ‰é™         | âš ï¸ æœ‰é™         | âŒ           |
| **ç¦»çº¿æ”¯æŒï¼ˆPWAï¼‰**  | âœ…                | âŒ              | âŒ              | âŒ           |
| **ä»·æ ¼**             | ä½ï¼ˆè‡ªæ‰˜ç®¡ï¼‰      | é«˜ï¼ˆ$60-90/å‘¨ï¼‰ | é«˜ï¼ˆ$65-99/å‘¨ï¼‰ | ä¸­ï¼ˆ$39/æœˆï¼‰ |

### æ ¸å¿ƒç«äº‰åŠ›

1. **å‚ç›´é¢†åŸŸä¸“æ³¨**
   - é’ˆå¯¹æ”¿æ²»åˆ›ä¼¤å¹¸å­˜è€…çš„ç‰¹å®šéœ€æ±‚
   - ä¸“é—¨çš„é£é™©æ£€æµ‹æ¨¡å¼ï¼ˆæµäº¡ç»æœ›ã€è¿«å®³ææƒ§ç­‰ï¼‰
   - å¤šè¯­è¨€æ”¯æŒï¼ˆéš¾æ°‘å¸¸ç”¨è¯­è¨€ï¼‰

2. **æŠ€æœ¯åˆ›æ–°**
   - å³æ—¶ä¸Šä¸‹æ–‡åŠ è½½ï¼š84% tokenèŠ‚çœ
   - æ··åˆé£é™©æ£€æµ‹ï¼šé€Ÿåº¦+å‡†ç¡®æ€§
   - AI-åŒ»ç”ŸååŒå·¥ä½œæµ

3. **æˆæœ¬ä¼˜åŠ¿**
   - å¼€æºï¼šå¯è‡ªæ‰˜ç®¡ï¼Œé™ä½è¿è¥æˆæœ¬
   - AIä¼˜åŒ–ï¼šé™ä½LLM APIæˆæœ¬
   - å¯è´Ÿæ‹…ï¼šç›¸æ¯”ä¼ ç»Ÿè¿œç¨‹æ²»ç–—ä¾¿å®œ70%+

4. **éšç§ä¸åˆè§„**
   - GDPRå®Œå…¨åˆè§„
   - ç«¯åˆ°ç«¯æ•°æ®æ§åˆ¶
   - å®¡è®¡æ—¥å¿—å®Œæ•´

5. **å¯æ‰©å±•æ€§**
   - ç°ä»£æŠ€æœ¯æ ˆï¼ˆFastAPI + Next.jsï¼‰
   - å®¹å™¨åŒ–éƒ¨ç½²
   - äº‘åŸç”Ÿæ¶æ„

---

## ğŸ“ æœªæ¥è·¯çº¿å›¾

### çŸ­æœŸï¼ˆ3-6ä¸ªæœˆï¼‰

- [ ] **ç§»åŠ¨åŸç”Ÿåº”ç”¨**ï¼šiOS + AndroidåŸç”ŸApp
- [ ] **ç¾¤ç»„æ”¯æŒ**ï¼šæ‚£è€…äº’åŠ©å°ç»„åŠŸèƒ½
- [ ] **è§†é¢‘å’¨è¯¢**ï¼šé›†æˆWebRTCè§†é¢‘é€šè¯
- [ ] **è¯ç‰©ç®¡ç†**ï¼šå¤„æ–¹è·Ÿè¸ªã€å‰¯ä½œç”¨è®°å½•
- [ ] **å®¶å±è®¿é—®**ï¼šå®¶å±è´¦æˆ·ï¼Œæœ‰é™æ•°æ®æŸ¥çœ‹

### ä¸­æœŸï¼ˆ6-12ä¸ªæœˆï¼‰

- [ ] **AIè¯­éŸ³å¯¹è¯**ï¼šé›†æˆè¯­éŸ³è¯†åˆ«å’Œåˆæˆ
- [ ] **æ™ºèƒ½æé†’**ï¼šåŸºäºè¡Œä¸ºæ¨¡å¼çš„ä¸»åŠ¨å…³æ€€
- [ ] **å¯ç©¿æˆ´è®¾å¤‡é›†æˆ**ï¼šApple Watchã€Fitbitæ•°æ®å¯¼å…¥
- [ ] **ç ”ç©¶æ•°æ®å¹³å°**ï¼šåŒ¿ååŒ–æ•°æ®ç”¨äºå­¦æœ¯ç ”ç©¶
- [ ] **ä¿é™©å¯¹æ¥**ï¼šä¸ä¿é™©å…¬å¸APIé›†æˆ

### é•¿æœŸï¼ˆ12ä¸ªæœˆ+ï¼‰

- [ ] **è”é‚¦å­¦ä¹ **ï¼šéšç§ä¿æŠ¤çš„AIæ¨¡å‹è®­ç»ƒ
- [ ] **XRæ²»ç–—**ï¼šVRæš´éœ²ç–—æ³•ã€å†¥æƒ³åœºæ™¯
- [ ] **åŸºå› ç»„å­¦é›†æˆ**ï¼šç²¾å‡†åŒ»ç–—ä¸ªæ€§åŒ–æ²»ç–—
- [ ] **å…¨çƒæ‰©å±•**ï¼šæ›´å¤šè¯­è¨€ï¼ˆå°åœ°è¯­ã€ä¹Œå°”éƒ½è¯­ç­‰ï¼‰
- [ ] **B2B SaaS**ï¼šé¢å‘åŒ»ç–—æœºæ„çš„ç™½æ ‡è§£å†³æ–¹æ¡ˆ

---

**æŠ¥å‘Šç¼–åˆ¶æ—¥æœŸ**ï¼š2026-02-09
**äº§å“ç‰ˆæœ¬**ï¼š1.0.0
**æ–‡æ¡£ç‰ˆæœ¬**ï¼š1.0.0
